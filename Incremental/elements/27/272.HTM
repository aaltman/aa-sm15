<b> : </b>67.4.2.&nbsp;Bottom-up Index Deletion<SPAN>&nbsp;</SPAN><A class=id_link style="BOX-SIZING: border-box; TEXT-DECORATION: none; FONT-WEIGHT: 600; COLOR: ; VISIBILITY: hidden; BACKGROUND-COLOR: transparent; transition: color 0.2s ease-in-out" href="https://www.postgresql.org/docs/current/btree-implementation.html#BTREE-DELETION"></A></H3></DIV></DIV></DIV>
<P style="BOX-SIZING: border-box; MARGIN-TOP: 0px">B-Tree indexes are not directly aware that under MVCC, there might be multiple extant versions of the same logical table row; to an index, each tuple is an independent object that needs its own index entry.<SPAN>&nbsp;</SPAN><SPAN class=quote style="BOX-SIZING: border-box">&#8220;<SPAN class=quote style="BOX-SIZING: border-box">Version churn</SPAN>&#8221;</SPAN><SPAN>&nbsp;</SPAN>tuples may sometimes accumulate and adversely affect query latency and throughput. This typically occurs with<SPAN>&nbsp;</SPAN><CODE class=command style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">UPDATE</CODE>-heavy workloads where most individual updates cannot apply the<SPAN>&nbsp;</SPAN><A title="73.7.&nbsp;Heap-Only Tuples (HOT)" class=link style="BOX-SIZING: border-box; TEXT-DECORATION: none; FONT-WEIGHT: 600; COLOR: ; BACKGROUND-COLOR: transparent; transition: color 0.2s ease-in-out" href="https://www.postgresql.org/docs/current/storage-hot.html"><ACRONYM class=acronym style="BOX-SIZING: border-box">HOT</ACRONYM><SPAN>&nbsp;</SPAN>optimization.</A><SPAN>&nbsp;</SPAN>Changing the value of only one column covered by one index during an<SPAN>&nbsp;</SPAN><CODE class=command style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">UPDATE</CODE><SPAN>&nbsp;</SPAN><SPAN class=emphasis style="BOX-SIZING: border-box"><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">always</EM></SPAN><SPAN>&nbsp;</SPAN>necessitates a new set of index tuples &#8212; one for<SPAN>&nbsp;</SPAN><SPAN class=emphasis style="BOX-SIZING: border-box"><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">each and every</EM></SPAN><SPAN>&nbsp;</SPAN>index on the table. Note in particular that this includes indexes that were not<SPAN>&nbsp;</SPAN><SPAN class=quote style="BOX-SIZING: border-box">&#8220;<SPAN class=quote style="BOX-SIZING: border-box">logically modified</SPAN>&#8221;</SPAN><SPAN>&nbsp;</SPAN>by the<SPAN>&nbsp;</SPAN><CODE class=command style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">UPDATE</CODE>. All indexes will need a successor physical index tuple that points to the latest version in the table. Each new tuple within each index will generally need to coexist with the original<SPAN>&nbsp;</SPAN><SPAN class=quote style="BOX-SIZING: border-box">&#8220;<SPAN class=quote style="BOX-SIZING: border-box">updated</SPAN>&#8221;</SPAN><SPAN>&nbsp;</SPAN>tuple for a short period of time (typically until shortly after the<SPAN>&nbsp;</SPAN><CODE class=command style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">UPDATE</CODE><SPAN>&nbsp;</SPAN>transaction commits).</P>
<P style="BOX-SIZING: border-box; MARGIN-TOP: 0px">B-Tree indexes incrementally delete version churn index tuples by performing<SPAN>&nbsp;</SPAN><EM class=firstterm style="BOX-SIZING: border-box; FONT-STYLE: italic">bottom-up index deletion</EM><SPAN>&nbsp;</SPAN>passes. Each deletion pass is triggered in reaction to an anticipated<SPAN>&nbsp;</SPAN><SPAN class=quote style="BOX-SIZING: border-box">&#8220;<SPAN class=quote style="BOX-SIZING: border-box">version churn page split</SPAN>&#8221;</SPAN>. This only happens with indexes that are not logically modified by<SPAN>&nbsp;</SPAN><CODE class=command style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">UPDATE</CODE><SPAN>&nbsp;</SPAN>statements, where concentrated build up of obsolete versions in particular pages would occur otherwise. A page split will usually be avoided, though it's possible that certain implementation-level heuristics will fail to identify and delete even one garbage index tuple (in which case a page split or deduplication pass resolves the issue of an incoming new tuple not fitting on a leaf page). The worst-case number of versions that any index scan must traverse (for any single logical row) is an important contributor to overall system responsiveness and throughput. A bottom-up index deletion pass targets suspected garbage tuples in a single leaf page based on<SPAN>&nbsp;</SPAN><SPAN class=emphasis style="BOX-SIZING: border-box"><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">qualitative</EM></SPAN><SPAN>&nbsp;</SPAN>distinctions involving logical rows and versions. This contrasts with the<SPAN>&nbsp;</SPAN><SPAN class=quote style="BOX-SIZING: border-box">&#8220;<SPAN class=quote style="BOX-SIZING: border-box">top-down</SPAN>&#8221;</SPAN><SPAN>&nbsp;</SPAN>index cleanup performed by autovacuum workers, which is triggered when certain<SPAN>&nbsp;</SPAN><SPAN class=emphasis style="BOX-SIZING: border-box"><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">quantitative</EM></SPAN><SPAN>&nbsp;</SPAN>table-level thresholds are exceeded (see<SPAN>&nbsp;</SPAN><A title="25.1.6.&nbsp;The Autovacuum Daemon" class=xref style="BOX-SIZING: border-box; TEXT-DECORATION: none; FONT-WEIGHT: 600; COLOR: ; BACKGROUND-COLOR: transparent; transition: color 0.2s ease-in-out" href="https://www.postgresql.org/docs/current/routine-vacuuming.html#AUTOVACUUM">Section&nbsp;25.1.6</A>).</P>
<DIV class=note style="BOX-SIZING: border-box; BORDER-TOP: 1px solid; BORDER-RIGHT: 1px solid; BORDER-BOTTOM: 1px solid; PADDING-TOP: 1px; PADDING-LEFT: 1px; BORDER-LEFT: 1px solid; MARGIN: 4ex auto; PADDING-RIGHT: 1px; border-radius: 8px">