<b> : </b>Tuning the circuit breaker threshold</H2>
<P style="BOX-SIZING: border-box; FONT-FAMILY: var(--desktop-large-body-copy-family); WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(26,26,26); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">While the default value of<SPAN>&nbsp;</SPAN><CODE style="BOX-SIZING: border-box; FONT-SIZE: 17px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: rgb(246,247,248); border-radius: 0.4rem">maxErrorRate=100</CODE><SPAN>&nbsp;</SPAN>has been proven to protect against metastable failures by the Aerospike performance engineering team, the optimal value ultimately depends on the use case.</P>
<P style="BOX-SIZING: border-box; FONT-FAMILY: var(--desktop-large-body-copy-family); WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(26,26,26); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Setting the threshold effectively puts a cap on the number of connections that are churned per second (approximately) in a worst-case failure scenario. The cost of a connection churn can vary. For example, a TLS connection takes more resources to establish than a plain TCP connection. Logging a message on every failure is more expensive than incrementing a counter.</P>
<P style="BOX-SIZING: border-box; FONT-FAMILY: var(--desktop-large-body-copy-family); WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(26,26,26); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">So the questions you have to ask are:</P>
<UL style='BOX-SIZING: border-box; FONT-SIZE: medium; FONT-FAMILY: "Neue Helvetica Now Pro", system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", sans-serif, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(26,26,26); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 5px 0px; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'>
<LI style="BOX-SIZING: border-box">
<P style="BOX-SIZING: border-box; FONT-FAMILY: var(--desktop-large-body-copy-family)">How many connections opened/closed per second can each of my application nodes reasonably handle?</P></LI>
<LI style="BOX-SIZING: border-box">
<P style="BOX-SIZING: border-box; FONT-FAMILY: var(--desktop-large-body-copy-family)">How many connections opened/closed per second can each of my database nodes reasonably handle?</P></LI></UL>
<P style="BOX-SIZING: border-box; FONT-FAMILY: var(--desktop-large-body-copy-family); WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(26,26,26); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Every Aerospike client instance connects to every server node. So, with 50 application nodes and the default value of<SPAN>&nbsp;</SPAN><CODE style="BOX-SIZING: border-box; FONT-SIZE: 17px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: rgb(246,247,248); border-radius: 0.4rem">maxErrorRate=100</CODE>, a single database node might see approximately 5,000 connections churned per second in the worst-case failure mode.</P>
<P style="BOX-SIZING: border-box; FONT-FAMILY: var(--desktop-large-body-copy-family); WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(26,26,26); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Then, consider what happens on the server when a connection churns. Depending on the type of failure, there might be a log message from the failure. When using the<SPAN>&nbsp;</SPAN><A style='BOX-SIZING: border-box; CURSOR: pointer; TEXT-DECORATION: none; FONT-FAMILY: var(--helvetica, "Neue Helvetica Now Pro"),Helvetica; BORDER-BOTTOM: rgb(0,122,171) 1px solid; COLOR: ' href="https://aerospike.com/docs/server/operations/configure/security/access-control">Aerospike authentication and audit logs</A><SPAN>&nbsp;</SPAN>there can be an audit log message for the attempted authentication while connecting. So with those two log messages there could be approximately 10,000 log messages per second during this type of failure mode.</P>
<P style="BOX-SIZING: border-box; FONT-FAMILY: var(--desktop-large-body-copy-family); WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(26,26,26); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Can your logging stack handle that volume from each Aerospike node?</P>
<P style="BOX-SIZING: border-box; FONT-FAMILY: var(--desktop-large-body-copy-family); WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(26,26,26); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Dropping the value down to<SPAN>&nbsp;</SPAN><CODE style="BOX-SIZING: border-box; FONT-SIZE: 17px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: rgb(246,247,248); border-radius: 0.4rem">maxErrorRate=5</CODE><SPAN>&nbsp;</SPAN>would lower that worst-case log volume down to approximately 250 log messages per second. The trade-off would be that a larger number of the transactions during that window would need to be addressed by the application (exponential back-off, dead-letter queue, etc).</P>
<P style="BOX-SIZING: border-box; FONT-FAMILY: var(--desktop-large-body-copy-family); WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(26,26,26); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">But that trade-off is acceptable if you leverage other techniques for resiliency at scale, such that the Circuit Breaker pattern is a last resort for just the most extreme failure scenarios. Less severe disruptions, such as high packet loss, single node failures, short-lived latency spikes, etc., can be mitigated before tripping the circuit breaker in the first place.</P>
<P style="BOX-SIZING: border-box; FONT-FAMILY: var(--desktop-large-body-copy-family); WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(26,26,26); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">The policies that can provide that additional resilience at scale are documented in the<SPAN>&nbsp;</SPAN><A style='BOX-SIZING: border-box; CURSOR: pointer; TEXT-DECORATION: none; FONT-FAMILY: var(--helvetica, "Neue Helvetica Now Pro"),Helvetica; BORDER-BOTTOM: rgb(0,122,171) 1px solid; COLOR: ' href="https://aerospike.com/developer/client/connection_tuning_guide">Aerospike Connection Tuning Guide</A>. An in-depth explanation about how they work is discussed in<SPAN>&nbsp;</SPAN><A style='BOX-SIZING: border-box; CURSOR: pointer; TEXT-DECORATION: none; FONT-FAMILY: var(--helvetica, "Neue Helvetica Now Pro"),Helvetica; BORDER-BOTTOM: rgb(0,122,171) 1px solid; COLOR: ' href="https://aerospike.com/blog/using-aerospike-policies-correctly/">Using Aerospike policies (correctly!)</A>.