<b> : </b>Patching the Cross-Compiler</H2>
<P style='FONT-SIZE: 16px; BORDER-TOP: 0px; FONT-FAMILY: Arimo, "Helvetica Neue", Arial, sans-serif; BORDER-RIGHT: 0px; VERTICAL-ALIGN: baseline; WHITE-SPACE: normal; WORD-SPACING: 0px; BORDER-BOTTOM: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(34,34,34); PADDING-BOTTOM: 0px; FONT-STYLE: normal; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: 0px; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 1.5em; LETTER-SPACING: normal; PADDING-RIGHT: 0px; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; font-variant-numeric: inherit; font-variant-east-asian: inherit; font-variant-alternates: inherit; font-variant-position: inherit; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'>Andrew Macleod<SPAN>&nbsp;</SPAN><A style="FONT-SIZE: 16px; TEXT-DECORATION: none; BORDER-TOP: 0px; FONT-FAMILY: inherit; BORDER-RIGHT: 0px; VERTICAL-ALIGN: baseline; BORDER-BOTTOM: 0px; COLOR: rgb(33,175,211); PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: 0px; MARGIN: 0px; PADDING-RIGHT: 0px; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; transition: color 0.3s" href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=59448#c15">posted a patch</A><SPAN>&nbsp;</SPAN>for this issue in the bug report. His patch adds the following lines near the end of the<SPAN>&nbsp;</SPAN><CODE style="FONT-SIZE: 0.9em; BORDER-TOP: rgb(238,238,238) 1px solid; FONT-FAMILY: cascadia_code, monospace; BORDER-RIGHT: rgb(238,238,238) 1px solid; VERTICAL-ALIGN: baseline; BACKGROUND: rgb(246,246,246); BORDER-BOTTOM: rgb(238,238,238) 1px solid; COLOR: rgb(70,70,70); PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0.3em; BORDER-LEFT: rgb(238,238,238) 1px solid; MARGIN: -1px 0px; DISPLAY: inline-block; LINE-HEIGHT: 1.5em; PADDING-RIGHT: 0.3em; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; border-radius: 0.4em">get_memmodel</CODE><SPAN>&nbsp;</SPAN>function in<SPAN>&nbsp;</SPAN><CODE style="FONT-SIZE: 0.9em; BORDER-TOP: rgb(238,238,238) 1px solid; FONT-FAMILY: cascadia_code, monospace; BORDER-RIGHT: rgb(238,238,238) 1px solid; VERTICAL-ALIGN: baseline; BACKGROUND: rgb(246,246,246); BORDER-BOTTOM: rgb(238,238,238) 1px solid; COLOR: rgb(70,70,70); PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0.3em; BORDER-LEFT: rgb(238,238,238) 1px solid; MARGIN: -1px 0px; DISPLAY: inline-block; LINE-HEIGHT: 1.5em; PADDING-RIGHT: 0.3em; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; border-radius: 0.4em">gcc/builtins.c</CODE>:</P><PRE style="FONT-SIZE: 13px; OVERFLOW: auto; BORDER-TOP: rgb(238,238,238) 1px solid; FONT-FAMILY: cascadia_code, monospace; BORDER-RIGHT: rgb(238,238,238) 1px solid; VERTICAL-ALIGN: baseline; BACKGROUND: rgb(246,246,246); WORD-SPACING: 0px; BORDER-BOTTOM: rgb(238,238,238) 1px solid; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(41,47,49); PADDING-BOTTOM: 0.8em; FONT-STYLE: normal; PADDING-TOP: 0.8em; PADDING-LEFT: 1em; BORDER-LEFT: rgb(238,238,238) 1px solid; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 2.1em; LETTER-SPACING: normal; LINE-HEIGHT: 1.38em; PADDING-RIGHT: 1em; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; font-variant-numeric: inherit; font-variant-east-asian: inherit; font-variant-alternates: inherit; font-variant-position: inherit; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; border-radius: 0.4em"><CODE style="FONT-SIZE: 13px; BORDER-TOP: 0px; FONT-FAMILY: cascadia_code, monospace; BORDER-RIGHT: 0px; VERTICAL-ALIGN: baseline; BORDER-BOTTOM: 0px; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: 0px; MARGIN: 0px; PADDING-RIGHT: 0px; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit">  /* Workaround for Bugzilla 59448. GCC doesn't track consume properly, so
     be conservative and promote consume to acquire.  */
  if (val == MEMMODEL_CONSUME)
    val = MEMMODEL_ACQUIRE;
</CODE></PRE>
<P style='FONT-SIZE: 16px; BORDER-TOP: 0px; FONT-FAMILY: Arimo, "Helvetica Neue", Arial, sans-serif; BORDER-RIGHT: 0px; VERTICAL-ALIGN: baseline; WHITE-SPACE: normal; WORD-SPACING: 0px; BORDER-BOTTOM: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(34,34,34); PADDING-BOTTOM: 0px; FONT-STYLE: normal; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: 0px; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 1.5em; LETTER-SPACING: normal; PADDING-RIGHT: 0px; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; font-variant-numeric: inherit; font-variant-east-asian: inherit; font-variant-alternates: inherit; font-variant-position: inherit; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'>Let&#8217;s apply this patch and build a new cross-compiler.</P><PRE style="FONT-SIZE: 13px; OVERFLOW: auto; BORDER-TOP: rgb(238,238,238) 1px solid; FONT-FAMILY: cascadia_code, monospace; BORDER-RIGHT: rgb(238,238,238) 1px solid; VERTICAL-ALIGN: baseline; BACKGROUND: rgb(246,246,246); WORD-SPACING: 0px; BORDER-BOTTOM: rgb(238,238,238) 1px solid; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(41,47,49); PADDING-BOTTOM: 0.8em; FONT-STYLE: normal; PADDING-TOP: 0.8em; PADDING-LEFT: 1em; BORDER-LEFT: rgb(238,238,238) 1px solid; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 2.1em; LETTER-SPACING: normal; LINE-HEIGHT: 1.38em; PADDING-RIGHT: 1em; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; font-variant-numeric: inherit; font-variant-east-asian: inherit; font-variant-alternates: inherit; font-variant-position: inherit; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; border-radius: 0.4em"><CODE style="FONT-SIZE: 13px; BORDER-TOP: 0px; FONT-FAMILY: cascadia_code, monospace; BORDER-RIGHT: 0px; VERTICAL-ALIGN: baseline; BORDER-BOTTOM: 0px; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: 0px; MARGIN: 0px; PADDING-RIGHT: 0px; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit">$ cd gcc-4.9.2/gcc
$ wget -qO- https://gcc.gnu.org/bugzilla/attachment.cgi?id=33831 | patch
$ cd ../../build-gcc
$ make
$ make install
$ cd ..
</CODE></PRE>
<P style='FONT-SIZE: 16px; BORDER-TOP: 0px; FONT-FAMILY: Arimo, "Helvetica Neue", Arial, sans-serif; BORDER-RIGHT: 0px; VERTICAL-ALIGN: baseline; WHITE-SPACE: normal; WORD-SPACING: 0px; BORDER-BOTTOM: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(34,34,34); PADDING-BOTTOM: 0px; FONT-STYLE: normal; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: 0px; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 1.5em; LETTER-SPACING: normal; PADDING-RIGHT: 0px; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; font-variant-numeric: inherit; font-variant-east-asian: inherit; font-variant-alternates: inherit; font-variant-position: inherit; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'>Now let&#8217;s compile the same source code as before:</P><PRE style="FONT-SIZE: 13px; OVERFLOW: auto; BORDER-TOP: rgb(238,238,238) 1px solid; FONT-FAMILY: cascadia_code, monospace; BORDER-RIGHT: rgb(238,238,238) 1px solid; VERTICAL-ALIGN: baseline; BACKGROUND: rgb(246,246,246); WORD-SPACING: 0px; BORDER-BOTTOM: rgb(238,238,238) 1px solid; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(41,47,49); PADDING-BOTTOM: 0.8em; FONT-STYLE: normal; PADDING-TOP: 0.8em; PADDING-LEFT: 1em; BORDER-LEFT: rgb(238,238,238) 1px solid; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 2.1em; LETTER-SPACING: normal; LINE-HEIGHT: 1.38em; PADDING-RIGHT: 1em; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; font-variant-numeric: inherit; font-variant-east-asian: inherit; font-variant-alternates: inherit; font-variant-position: inherit; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; border-radius: 0.4em"><CODE style="FONT-SIZE: 13px; BORDER-TOP: 0px; FONT-FAMILY: cascadia_code, monospace; BORDER-RIGHT: 0px; VERTICAL-ALIGN: baseline; BORDER-BOTTOM: 0px; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: 0px; MARGIN: 0px; PADDING-RIGHT: 0px; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit">$ aarch64-linux-g++ -std=c++11 -O2 -S consumetest.cpp
$ cat consumetest.s
</CODE></PRE>
<P style='FONT-SIZE: 16px; BORDER-TOP: 0px; FONT-FAMILY: Arimo, "Helvetica Neue", Arial, sans-serif; BORDER-RIGHT: 0px; VERTICAL-ALIGN: baseline; WHITE-SPACE: normal; WORD-SPACING: 0px; BORDER-BOTTOM: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(34,34,34); PADDING-BOTTOM: 0px; FONT-STYLE: normal; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: 0px; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 1.5em; LETTER-SPACING: normal; PADDING-RIGHT: 0px; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; font-variant-numeric: inherit; font-variant-east-asian: inherit; font-variant-alternates: inherit; font-variant-position: inherit; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'><IMG class=center style="FONT-SIZE: 16px; MAX-WIDTH: 100%; BORDER-TOP: 0px; HEIGHT: auto; FONT-FAMILY: inherit; BORDER-RIGHT: 0px; VERTICAL-ALIGN: baseline; BORDER-BOTTOM: 0px; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: 0px; MARGIN: 0px auto 1.5em; DISPLAY: block; PADDING-RIGHT: 0px; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit" src="https://preshing.com/images/gcc-consume-aarch64-fixed.png"></P>
<P style='FONT-SIZE: 16px; BORDER-TOP: 0px; FONT-FAMILY: Arimo, "Helvetica Neue", Arial, sans-serif; BORDER-RIGHT: 0px; VERTICAL-ALIGN: baseline; WHITE-SPACE: normal; WORD-SPACING: 0px; BORDER-BOTTOM: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(34,34,34); PADDING-BOTTOM: 0px; FONT-STYLE: normal; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: 0px; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 1.5em; LETTER-SPACING: normal; PADDING-RIGHT: 0px; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; font-variant-numeric: inherit; font-variant-east-asian: inherit; font-variant-alternates: inherit; font-variant-position: inherit; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'>This time, the generated assembly is valid. The compiler now implements the load-consume from<SPAN>&nbsp;</SPAN><CODE style="FONT-SIZE: 0.9em; BORDER-TOP: rgb(238,238,238) 1px solid; FONT-FAMILY: cascadia_code, monospace; BORDER-RIGHT: rgb(238,238,238) 1px solid; VERTICAL-ALIGN: baseline; BACKGROUND: rgb(246,246,246); BORDER-BOTTOM: rgb(238,238,238) 1px solid; COLOR: rgb(70,70,70); PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0.3em; BORDER-LEFT: rgb(238,238,238) 1px solid; MARGIN: -1px 0px; DISPLAY: inline-block; LINE-HEIGHT: 1.5em; PADDING-RIGHT: 0.3em; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; border-radius: 0.4em">Guard</CODE><SPAN>&nbsp;</SPAN>using<SPAN>&nbsp;</SPAN><CODE style="FONT-SIZE: 0.9em; BORDER-TOP: rgb(238,238,238) 1px solid; FONT-FAMILY: cascadia_code, monospace; BORDER-RIGHT: rgb(238,238,238) 1px solid; VERTICAL-ALIGN: baseline; BACKGROUND: rgb(246,246,246); BORDER-BOTTOM: rgb(238,238,238) 1px solid; COLOR: rgb(70,70,70); PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0.3em; BORDER-LEFT: rgb(238,238,238) 1px solid; MARGIN: -1px 0px; DISPLAY: inline-block; LINE-HEIGHT: 1.5em; PADDING-RIGHT: 0.3em; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; border-radius: 0.4em">ldar</CODE>, a<SPAN>&nbsp;</SPAN><A style="FONT-SIZE: 16px; TEXT-DECORATION: none; BORDER-TOP: 0px; FONT-FAMILY: inherit; BORDER-RIGHT: 0px; VERTICAL-ALIGN: baseline; BORDER-BOTTOM: 0px; COLOR: rgb(33,175,211); PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: 0px; MARGIN: 0px; PADDING-RIGHT: 0px; font-stretch: inherit; font-optical-sizing: inherit; font-size-adjust: inherit; font-kerning: inherit; font-feature-settings: inherit; font-variation-settings: inherit; transition: color 0.3s" href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0802a/LDAR.html">new AArch64 instruction</A><SPAN>&nbsp;</SPAN>that provides acquire semantics. This instruction acts as a memory barrier on the load itself, ensuring that the load will be completed before all subsequent loads and stores (among other things). In other words, our AArch64 cross-compiler now implements the &#8220;heavy&#8221; strategy correctly.