<H1 id=zfs-tunables style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">ZFS tunables</H1>
<H2 id=setting-recordsize-to-8k style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Setting<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize</CODE><SPAN>&nbsp;</SPAN>to<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>8k</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">While the default<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize</CODE><SPAN>&nbsp;</SPAN>of ZFS is<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>128k</CODE>, a<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize</CODE><SPAN>&nbsp;</SPAN>of<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>8k</CODE><SPAN>&nbsp;</SPAN>exactly matches the sizing that<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="http://www.postgresql.org/docs/current/storage-page-layout.html" rel=nopopener target=_blank>Postgres&#8217;s page size</A><SPAN>&nbsp;</SPAN>&#8211; this is great for postgres since it cuts down on unnecessary writes (especially to solid state disks), and it gets even better with compression made available by ZFS.</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">One thing I misunderstood about this (and<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.reddit.com/r/zfs/comments/qgkk1c/numbers_from_zfs_vs_lvmmdraid_fio_tests_on_nvme/hiaf5qo/" rel=nopopener target=_blank>thankfully was corrected by /u/mercenary_sysadmin on Reddit</A>), is that while the default<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize</CODE><SPAN>&nbsp;</SPAN>of<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>128k</CODE><SPAN>&nbsp;</SPAN>can be considered an &#8220;upper bound&#8221;, random IO in large files is done in increments of<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize</CODE>. He&#8217;s laid it out pretty nicely so I&#8217;ll copy his comment here:</P>
<BLOCKQUOTE style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); PADDING-BOTTOM: 1em; FONT-STYLE: italic; TEXT-ALIGN: justify; PADDING-TOP: 1em; PADDING-LEFT: 1em; BORDER-LEFT: green 0.25em solid; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; PADDING-RIGHT: 1em; BACKGROUND-COLOR: rgb(238,238,238); MARGIN-RIGHT: 3px; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<P style="BOX-SIZING: border-box; MARGIN: 0.75em 0px; LETTER-SPACING: 0px; LINE-HEIGHT: 1.12em">recordsize is only &#8220;an upper bound&#8221; in the sense that small files get small records. For any workload which does random I/O inside larger files, recordsize is exactly the increment which the random I/O happens in.</P>
<P style="BOX-SIZING: border-box; MARGIN: 0.75em 0px; LETTER-SPACING: 0px; LINE-HEIGHT: 1.12em">If you set recordsize=1M as you originally did, but then test with eg blocksize=4K, you get an amplification factor of 256x&#8230; and, even worse, you get a read-modify-write cycle when re-writing blocks.</P>
<P style="BOX-SIZING: border-box; MARGIN: 0.75em 0px; LETTER-SPACING: 0px; LINE-HEIGHT: 1.12em">Let&#8217;s say you ask fio to do a bs=4K run when recordsize=1M. When fio wants to write 4K of new data to the middle of a testfile, it first has to read in 1M of data, then modify 4K out of that data, then write all 1M back out again.</P>
<P style="BOX-SIZING: border-box; MARGIN: 0.75em 0px 0px; LETTER-SPACING: 0px; LINE-HEIGHT: 1.12em">If you re-run the test on a dataset with recordsize=4K there is no RMW and no amplification&#8212;you ask fio to write 4K of data to the middle of the testfile, it writes 4K of data, done.</P></BLOCKQUOTE>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Obviously a<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>blocksize=1M</CODE><SPAN>&nbsp;</SPAN>is not a reasonable (the tests I ran that he&#8217;s referring to are<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>fio</CODE><SPAN>&nbsp;</SPAN>tests) but it was a pretty big insight to me to realize that<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize</CODE><SPAN>&nbsp;</SPAN>isn&#8217;t automatically pared down. I&#8217;ve seen some arguments against modifying<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize</CODE><SPAN>&nbsp;</SPAN>but at this point it looks pretty clear that aligning the storage to the IO you&#8217;re going to do (and avoiding write amplification wher epossible) is a good idea.</P>
<H2 id=optional-setting-recordsize-to-16k style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">(optional) Setting<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize</CODE><SPAN>&nbsp;</SPAN>to<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>16k</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">A<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://people.freebsd.org/~seanc/postgresql/scale15x-2017-postgresql_zfs_best_practices.pdf" rel=nopopener target=_blank>talk from Scale15x in 2017</A><SPAN>&nbsp;</SPAN>recommends<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>blocksize=16k</CODE>. The primary reason here was being able to essentially pre-fault the next page, which is very useful for sequential scans.</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">It&#8217;s not related to Postgres but<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.percona.com/blog/mysql-zfs-performance-update/" rel=nopopener target=_blank>percona also has a decent post on the effect on MySQL (which does have 16k record sizes)</A>.</P>
<H2 id=enable-compression style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Enable<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>compression</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Regardless of your<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize</CODE>, Postgres and your storage density in general will benefit from enabling<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>compression</CODE>. While compression may increase the CPU resources required by ZFS, it&#8217;s worth it, as with<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>compresssion=lz4</CODE><SPAN>&nbsp;</SPAN>(or<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://vadosware.io/post/everything-ive-seen-on-optimizing-postgres-on-zfs-on-linux/">the newer<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zstd</CODE></A>, you can expect more data to fit in the same space on disk &#8211; compression rates can vary hugely but members of the community (giving talks) have reported compression ratios anywhere from 1 to 100 (realistically you&#8217;ll probably see 1-4x space savings).</P>
<H2 id=benchmark-pgbench-recordsize8k-vs-recordsize16k style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Benchmark (<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>pgbench</CODE>):<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize=8k</CODE><SPAN>&nbsp;</SPAN>vs<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize=16k</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">As this is relatively easy to test, I set up some<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>pgbench</CODE><SPAN>&nbsp;</SPAN>marks to figure out if there was a large difference between<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>8k</CODE><SPAN>&nbsp;</SPAN>and<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>16k</CODE>. In general the settings were as follows:</P>
<UL style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0.5em; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0.5em; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>pgbench</CODE><SPAN>&nbsp;</SPAN>jobs have 4 CPU 8GB 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>postgres</CODE><SPAN>&nbsp;</SPAN>instances have 4 CPU 16GB, with storage of 32GB 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>full_page_writes=off</CODE><SPAN>&nbsp;</SPAN>(because ZFS) 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>wal_init_zero=off</CODE><SPAN>&nbsp;</SPAN>(because ZFS) 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>wal_recycle=off</CODE><SPAN>&nbsp;</SPAN>(because ZFS)</LI></UL>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">The results for<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize=8k</CODE>:</P><DETAILS style="BOX-SIZING: border-box; FONT-SIZE: 20px; BORDER-TOP: rgb(170,170,170) 1px solid; FONT-FAMILY: sans-serif; BORDER-RIGHT: rgb(170,170,170) 1px solid; WHITE-SPACE: normal; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(170,170,170) 1px solid; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); PADDING-BOTTOM: 0px; FONT-STYLE: normal; PADDING-TOP: 0.5em; PADDING-LEFT: 0.5em; BORDER-LEFT: rgb(170,170,170) 1px solid; ORPHANS: 2; WIDOWS: 2; DISPLAY: block; LETTER-SPACING: normal; PADDING-RIGHT: 0.5em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; border-radius: 4px"><SUMMARY style="BOX-SIZING: border-box; FONT-WEIGHT: bold; PADDING-BOTTOM: 0.5em; PADDING-TOP: 0.5em; PADDING-LEFT: 0.5em; MARGIN: -0.5em -0.5em 0px; DISPLAY: block; PADDING-RIGHT: 0.5em">&#55357;&#56540;&#65039; PGBench output (click to expand)</SUMMARY> 
<DIV class=highlight style="BOX-SIZING: border-box"><PRE tabIndex=0 style='BOX-SIZING: border-box; BORDER-TOP: medium none; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; WORD-BREAK: break-all; COLOR: rgb(85,85,85); PADDING-BOTTOM: 2em; PADDING-TOP: 2em; PADDING-LEFT: 2em; BORDER-LEFT: medium none; MARGIN: 0px 0px 13px; DISPLAY: block; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 2em; BACKGROUND-COLOR: rgb(248,248,248); border-radius: 0.5em; overflow-wrap: break-word; tab-size: 4'><CODE class=language-console style='BOX-SIZING: border-box; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; WHITE-SPACE: pre-wrap; COLOR: ; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent; border-radius: 0px' data-lang="console"><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN></CODE></PRE></DIV></DETAILS>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">The results for<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize=16k</CODE>:</P><DETAILS style="BOX-SIZING: border-box; FONT-SIZE: 20px; BORDER-TOP: rgb(170,170,170) 1px solid; FONT-FAMILY: sans-serif; BORDER-RIGHT: rgb(170,170,170) 1px solid; WHITE-SPACE: normal; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(170,170,170) 1px solid; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); PADDING-BOTTOM: 0px; FONT-STYLE: normal; PADDING-TOP: 0.5em; PADDING-LEFT: 0.5em; BORDER-LEFT: rgb(170,170,170) 1px solid; ORPHANS: 2; WIDOWS: 2; DISPLAY: block; LETTER-SPACING: normal; PADDING-RIGHT: 0.5em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; border-radius: 4px"><SUMMARY style="BOX-SIZING: border-box; FONT-WEIGHT: bold; PADDING-BOTTOM: 0.5em; PADDING-TOP: 0.5em; PADDING-LEFT: 0.5em; MARGIN: -0.5em -0.5em 0px; DISPLAY: block; PADDING-RIGHT: 0.5em">&#55357;&#56540;&#65039; PGBench output (recordsize=16k) (click to expand)</SUMMARY> 
<DIV class=highlight style="BOX-SIZING: border-box"><PRE tabIndex=0 style='BOX-SIZING: border-box; BORDER-TOP: medium none; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; WORD-BREAK: break-all; COLOR: rgb(85,85,85); PADDING-BOTTOM: 2em; PADDING-TOP: 2em; PADDING-LEFT: 2em; BORDER-LEFT: medium none; MARGIN: 0px 0px 13px; DISPLAY: block; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 2em; BACKGROUND-COLOR: rgb(248,248,248); border-radius: 0.5em; overflow-wrap: break-word; tab-size: 4'><CODE class=language-console style='BOX-SIZING: border-box; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; WHITE-SPACE: pre-wrap; COLOR: ; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent; border-radius: 0px' data-lang="console"><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN></CODE></PRE></DIV></DETAILS>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial"><STRONG style="BOX-SIZING: border-box; FONT-WEIGHT: 700">Wow, a ~20% improvement there</STRONG><SPAN>&nbsp;</SPAN>&#8211; looks like<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize=16k</CODE><SPAN>&nbsp;</SPAN>is the better setting in this<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">very</EM><SPAN>&nbsp;</SPAN>limited set of testing.</P>
<H2 id=reducing-read-ahead style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Reducing read-ahead</H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">ZFS read ahead should be minimized as much as possible &#8211; as a lot of random IO will be happening inside of given files which may not be read completely. This tip was contributed by /u/mercenary_sysadmin and seems to be good advice as well. I&#8217;ll let the quote speak for itself:</P>
<BLOCKQUOTE style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); PADDING-BOTTOM: 1em; FONT-STYLE: italic; TEXT-ALIGN: justify; PADDING-TOP: 1em; PADDING-LEFT: 1em; BORDER-LEFT: green 0.25em solid; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; PADDING-RIGHT: 1em; BACKGROUND-COLOR: rgb(238,238,238); MARGIN-RIGHT: 3px; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<P style="BOX-SIZING: border-box; MARGIN: 0.75em 0px 0px; LETTER-SPACING: 0px; LINE-HEIGHT: 1.12em">There are some other tweaks you want with postgres as a workload; readhead should generally be off for one thing (as it should be in any dataset where you&#8217;re primarily doing random I/O inside files which are not expected to need to be read in their entirety).</P></BLOCKQUOTE>
<H2 id=tuning-primarycache style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Tuning<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>primarycache</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.patpro.net/blog/index.php/2014/03/19/2628-zfs-primarycache-all-versus-metadata/" rel=nopopener target=_blank><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>primarycache</CODE><SPAN>&nbsp;</SPAN>is a ZFS tunable</A><SPAN>&nbsp;</SPAN>that can be set to<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>all</CODE><SPAN>&nbsp;</SPAN>or<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>metadata</CODE>, and generally the rule seems to be:</P>
<UL style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0.5em; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0.5em; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">If it fits in RAM = primarycache=metadata 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">If your working set exceeds RAM, primary_cache=all</LI></UL>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">This goes with a few more modifications to prevent double-caching:</P>
<UL style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0.5em; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0.5em; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">max ARC size = 15%-&gt;25% 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>shared_buffers</CODE><SPAN>&nbsp;</SPAN>=&gt; physical RAM + 50%</LI></UL>
<H1 id=zfs-related-tunables-on-the-postgres-side style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">ZFS-related tunables on the Postgres side</H1>
<H2 id=setting-full_page_writesoff style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Setting<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>full_page_writes=off</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">This is a pretty common recommendation, for good reason. It comes up in the<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://people.freebsd.org/~seanc/postgresql/scale15x-2017-postgresql_zfs_best_practices.pdf" rel=nopopener target=_blank>Scale15x talk from 2017</A><SPAN>&nbsp;</SPAN>and lots of other places. ZFS does not need full page writes to prevent torn pages, because ZFS never tears pages (yay for<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://en.wikipedia.org/wiki/Copy_on_write" rel=nopopener target=_blank>Copy on Write</A>.</P>
<H3 id=drawback-interferes-with-cascading-replication style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: bold; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Drawback: &#8220;interferes&#8221; with cascading replication</H3>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">This does suffer from a drawback that it can interfere with cascading replication &#8211; I haven&#8217;t run into this issue in particular myself wiht this setup, but as cascading replication itself is pretty niche (and there are a bunch of options/things you can try to do), I didn&#8217;t think to look into it too much, or try to reproduce.</P>
<H2 id=disable-postgres-checksumming style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Disable postgres checksumming</H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">ZFS is doing all the checksumming, scrubbing and safe writing you&#8217;ll need. By default<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.postgresql.org/docs/14/checksums.html" rel=nopopener target=_blank>data checksums are off</A>:</P>
<BLOCKQUOTE style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); PADDING-BOTTOM: 1em; FONT-STYLE: italic; TEXT-ALIGN: justify; PADDING-TOP: 1em; PADDING-LEFT: 1em; BORDER-LEFT: green 0.25em solid; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; PADDING-RIGHT: 1em; BACKGROUND-COLOR: rgb(238,238,238); MARGIN-RIGHT: 3px; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<P style="BOX-SIZING: border-box; MARGIN: 0.75em 0px 0px; LETTER-SPACING: 0px; LINE-HEIGHT: 1.12em">By default, data pages are not protected by checksums, but this can optionally be enabled for a cluster.</P></BLOCKQUOTE>
<H2 id=disable-postgres-compression style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Disable Postgres compression</H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Since ZFS will be compressing all the data before it hits disk (and has access to some better compression tech like<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zstd</CODE><SPAN>&nbsp;</SPAN>first), you can pretty safely let ZFS handle your compression as well. Postgres compression<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">may</EM><SPAN>&nbsp;</SPAN>still offer an advantage in certain situations with certain data storage patterns but in general it should be much less advantageous considering the lower layer compression at work.</P>
<H2 id=tune-wal_init_zero--wal_recycle style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Tune<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>wal_init_zero</CODE><SPAN>&nbsp;</SPAN>&amp;<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>wal_recycle</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">In a<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blog.crunchydata.com/blog/waiting-for-postgis-3.1-performance" rel=nopopener target=_blank>paper created by Tomas Munro over at Microsoft</A>, there&#8217;s lots of insight on how to run Postgres on FreeBSD (which of course<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://docs.freebsd.org/handbook/zfs-zpool.html" rel=nopopener target=_blank>utilizes ZFS</A>), but one that stuck out to me was tuning the<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>wal_init_zero</CODE><SPAN>&nbsp;</SPAN>and<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>wal_recycle</CODE><SPAN>&nbsp;</SPAN>options for Postgres &#8211; they help you avoid zero-filling of new files used for<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.postgresql.org/docs/current/runtime-config-wal.html" rel=nopopener target=_blank>Postgres&#8217;s Write Ahead Log</A>. The reasoning here is that since ZFS overwrites these anyway, you might as well get yourself a new inode.</P>
<H2 id=tune-wal_sync_method-trying-fdatasync style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Tune<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>wal_sync_method</CODE>, trying<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>fdatasync</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">This tip also comes from<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blog.crunchydata.com/blog/waiting-for-postgis-3.1-performance" rel=nopopener target=_blank>Thomas&#8217;s paper</A>, but the insight here is that we can skip writing metadata (the difference between<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://linux.die.net/man/2/fdatasync" rel=nopopener target=_blank><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>fdatasync</CODE><SPAN>&nbsp;</SPAN>and<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>fsync</CODE></A>), and save ourselves some time writing to disk.</P>
<H3 id=warning-dont-do-this-if-you-cant-rely-on-your-drives-writeback-caching style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: bold; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">WARNING: Don&#8217;t do this if you can&#8217;t rely on your drive&#8217;s writeback caching</H3>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">I&#8217;ve found out the painful way (by getting instant data corruption on large<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>pgbench</CODE>runs) that it may be possible that you can&#8217;t rely on your drives writeback cache &#8211;<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>fsync</CODE><SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">must</EM><SPAN>&nbsp;</SPAN>be used in these cases. I found this in particular with<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.samsung.com/semiconductor/ssd/client-ssd/MZVLB512HBJQ-00$00-07/" rel=nopopener target=_blank>consumer-grade Samsung MZVLB512HBJQ disks</A>, but probably best to be wary of it in general, and run some punishing<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>pgbench</CODE><SPAN>&nbsp;</SPAN>runs before you put anything in production (and of course, have backups handy.</P>
<H3 id=drawback-modified-time-may-be-lost-after-crash style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: bold; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Drawback: modified time may be lost after crash</H3>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">As Thomas goes into (read the slides!), there are some issues where modified time may be lost after a crash.</P>
<H3 id=alternative-wal_sync_methodopen_datasync style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: bold; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Alternative:<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>wal_sync_method=open_datasync</CODE></H3>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">An alternative to<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>fdatasync</CODE><SPAN>&nbsp;</SPAN>is to use<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>open_datasync</CODE>, which is equivalent to trying to write WAL with<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>open()</CODE><SPAN>&nbsp;</SPAN>and the option<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>O_DSYNC</CODE><SPAN>&nbsp;</SPAN>set. As of the time of this post, ZoL does not support Direct IO (it&#8217;s in the work), so Im&#8217; not sure how much benefit there is to this.</P>
<H3 id=future-alternative-wal_sync_methodaio_fsyncdatasync style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: bold; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Future Alternative:<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>wal_sync_method=aio_f[sync|datasync]</CODE>?</H3>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Plugging into the Linux async IO pipeline for WAL syncing seems like a pretty attractive option that will be available in the future.</P>
<H2 id=increasing-postgres-blocksize style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Increasing Postgres<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>blocksize</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Vladimir Mihailenco who maintains<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://bun.uptrace.dev/" rel=nopopener target=_blank>Bun (A DB client for Postres, MySQL and SQLite)</A><SPAN>&nbsp;</SPAN>has a<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://bun.uptrace.dev/" rel=nopopener target=_blank>great guide and and explaration on PoZoL</A>. His insight flips the<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize</CODE><SPAN>&nbsp;</SPAN>insight in the ZFS section and flips it on it&#8217;s head &#8211; we focused on decreasing<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize</CODE><SPAN>&nbsp;</SPAN>to match Postgres&#8217;s default<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>blocksize</CODE>, but there&#8217;s also the option of actually<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">increasing</EM><SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>blocksize</CODE><SPAN>&nbsp;</SPAN>on the postres side. This requires rebuilding Postgres but can considerably improve data-hungry queries. A quote:</P>
<BLOCKQUOTE style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); PADDING-BOTTOM: 1em; FONT-STYLE: italic; TEXT-ALIGN: justify; PADDING-TOP: 1em; PADDING-LEFT: 1em; BORDER-LEFT: green 0.25em solid; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; PADDING-RIGHT: 1em; BACKGROUND-COLOR: rgb(238,238,238); MARGIN-RIGHT: 3px; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<P style="BOX-SIZING: border-box; MARGIN: 0.75em 0px 0px; LETTER-SPACING: 0px; LINE-HEIGHT: 1.12em">You can improve this situation by increasing PostgreSQL block size to 32k and WAL block size to 64k. This requires re-compiling PostgreSQL and re-initializing [the] database.</P></BLOCKQUOTE>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">As he notes the principal tension here is that smaller blocksize will usually mean higher Transactions Per Second (TPS). This one I&#8217;m not too sure about doing but it&#8217;s definitely a fascinating experiment to try someday.</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">*** Drawback: requires recompile</P>
<H2 id=controversial-zfs_txg_timeout1--synchronous_commitoff--logbiasthroughput style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">(Controversial)<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zfs_txg_timeout=1</CODE><SPAN>&nbsp;</SPAN>&amp;<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>synchronous_commit=off</CODE><SPAN>&nbsp;</SPAN>&amp;<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>logbias=throughput</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">This intense bit of advice comes from the<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://people.freebsd.org/~seanc/postgresql/scale15x-2017-postgresql_zfs_best_practices.pdf" rel=nopopener target=_blank>Scale15x talk</A><SPAN>&nbsp;</SPAN>&#8211; the idea is that setting the ZFS transaction flushing timeout (<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zfs_txg_timeout</CODE>) which is 5 seconds by default<SPAN>&nbsp;</SPAN><STRONG style="BOX-SIZING: border-box; FONT-WEIGHT: 700">to only 1 second</STRONG><SPAN>&nbsp;</SPAN>gives you lots more performance at the risk of 1 second of data loss (with writes not being written to disk). Not waiting for writes to be served at all at the Postgres level, but allowing for approximately 1 second of possible data loss seems like a pretty reasonable tradeoff, but of course turning<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>synchronous_commit</CODE><SPAN>&nbsp;</SPAN>to<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>off</CODE><SPAN>&nbsp;</SPAN>is definitely something anyone should think about well before doing.</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">.ZFS plays into this beause it will never be inconsistent, so you don&#8217;t have to worry so much about data integrity. Considering the problems I had with<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>fdatasync</CODE><SPAN>&nbsp;</SPAN>I&#8217;m a little worried about this but it&#8217;s definitely worth trying. Another thing that makes this hard to try is that this is a pool-wide setting &#8211; it can&#8217;t be set<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.reddit.com/r/zfs/comments/76cj5f/can_i_set_zfs_txg_timeout_on_a_dataset/" rel=nopopener target=_blank>on just one dataset</A></P>
<H3 id=drawback-1s-of-data-loss style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: bold; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Drawback: 1s of data loss</H3>
<H3 id=drawback-horrific-fragmentation style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: bold; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Drawback: &#8220;horrific&#8221; fragmentation</H3>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial"><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">Yet another</EM><SPAN>&nbsp;</SPAN>quote from /u/mercenary_sysadmin (<A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.reddit.com/r/zfs/comments/azt8sz/logbiasthroughput_without_a_slog/)" rel=nopopener target=_blank>https://www.reddit.com/r/zfs/comments/azt8sz/logbiasthroughput_without_a_slog/)</A>:</P>
<BLOCKQUOTE style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); PADDING-BOTTOM: 1em; FONT-STYLE: italic; TEXT-ALIGN: justify; PADDING-TOP: 1em; PADDING-LEFT: 1em; BORDER-LEFT: green 0.25em solid; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; PADDING-RIGHT: 1em; BACKGROUND-COLOR: rgb(238,238,238); MARGIN-RIGHT: 3px; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<P style="BOX-SIZING: border-box; MARGIN: 0.75em 0px; LETTER-SPACING: 0px; LINE-HEIGHT: 1.12em">logbias=throughput with no SLOG will likely improve performance if your workload is lots of big block writes, which is a workload that usually isn&#8217;t suffering from performance issues much in the first place.</P>
<P style="BOX-SIZING: border-box; MARGIN: 0.75em 0px 0px; LETTER-SPACING: 0px; LINE-HEIGHT: 1.12em">Logbias=throughput with no SLOG and small block writes will result in the most horrific fragmentation imaginable, which will penalize you both in the initial writes AND when you reread that data from metal later.</P></BLOCKQUOTE>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Unfortunately I don&#8217;t have any direct tests I can show for this (they&#8217;d be easy to run, only one ZFS setting needs to be changed), but hopefully I&#8217;ll get a chance to test this out. The logic is pretty sound so it looks like<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>logbias=latency</CODE><SPAN>&nbsp;</SPAN>results in much better metadta/data spacing.</P>
<H2 id=setting-logbiaslatency-instead-of-logbiasthroughput style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Setting<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>logbias=latency</CODE><SPAN>&nbsp;</SPAN>(instead of<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>logbias=throughput</CODE>)</H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">The<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://bun.uptrace.dev/postgres/tuning-zfs-aws-ebs.html#logbias" rel=nopopener target=_blank>Bun guide has a great setction on<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>logbias</CODE></A><SPAN>&nbsp;</SPAN>&#8211;<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>logbias=throughput</CODE><SPAN>&nbsp;</SPAN>looks to cause lots of fragmentation and is generally<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">not</EM><SPAN>&nbsp;</SPAN>a good idea.</P>
<H2 id=update-20211221-results-from-zfs_txg_timeout1syncdisabledlogbiaslatency style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Update (2021/12/21): Results from<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zfs_txg_timeout=1</CODE>,<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>sync=disabled</CODE>,<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>logbias=latency</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">In local testing I&#8217;ve found that 16k has the slight edge over 8k, and zstd has the slight edge over lz4, so I wanted to test<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zfs_txg_timeout</CODE><SPAN>&nbsp;</SPAN>as well, and I did &#8211; it turns out it also has an edge over the 5s wait (on NVMe, at least) &#8211; with no visible downsides (so far). The timeout used to be much longer for ZFS and went from 30 seconds to 5 &#8211; moving the rest of the distance from 5 to 1 (and why you should/shouldn&#8217;t) seems to be more rarely discussed.</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">If I had to guess (as I&#8217;m not a ZFS expert) the issues would be drive wear, inefficient transaction groupings (maybe when doing particularly large writes), and in general this is probably something that only make sense on NVMe.</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Anyway, here are the results for<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>recordsize=16k</CODE>,<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>compression=zstd</CODE>,<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>logbias=latency</CODE>, with<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zfs_txg_timeout=5</CODE><SPAN>&nbsp;</SPAN>(the default):</P>
<DIV class=highlight style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial"><PRE tabIndex=0 style='BOX-SIZING: border-box; BORDER-TOP: rgb(225,217,212) 0.5em dashed; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(225,217,212) 0.5em dashed; BORDER-BOTTOM: rgb(225,217,212) 0.5em dashed; WORD-BREAK: break-all; COLOR: rgb(85,85,85); PADDING-BOTTOM: 2em; PADDING-TOP: 2em; PADDING-LEFT: 2em; BORDER-LEFT: rgb(225,217,212) 0.5em dashed; MARGIN: 0px 0px 13px; DISPLAY: block; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 2em; BACKGROUND-COLOR: rgb(248,248,248); border-radius: 0.5em; overflow-wrap: break-word; tab-size: 4'><CODE class=language-console style='BOX-SIZING: border-box; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; WHITE-SPACE: pre-wrap; COLOR: ; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent; border-radius: 0px' data-lang="console"><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">pgbench (14.1)
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">starting vacuum...end.
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">transaction type: &lt;builtin: TPC-B (sort of)&gt;
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">scaling factor: 1000
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">query mode: simple
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">number of clients: 40
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">number of threads: 4
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">duration: 300 s
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">number of transactions actually processed: 1088807
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">latency average = 11.018 ms
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">initial connection time = 102.951 ms
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">tps = 3630.302820 (without initial connection time)
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">statement latencies in milliseconds:
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.001  \set aid random(1, 100000 * :scale)
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.001  \set bid random(1, 1 * :scale)
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.001  \set tid random(1, 10 * :scale)
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.000  \set delta random(-5000, 5000)
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.585  BEGIN;
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         1.141  UPDATE pgbench_accounts SET abalance = abalance + :delta WHERE aid = :aid;
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.685  SELECT abalance FROM pgbench_accounts WHERE aid = :aid;
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.676  UPDATE pgbench_tellers SET tbalance = tbalance + :delta WHERE tid = :tid;
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.775  UPDATE pgbench_branches SET bbalance = bbalance + :delta WHERE bid = :bid;
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.733  INSERT INTO pgbench_history (tid, bid, aid, delta, mtime) VALUES (:tid, :bid, :aid, :delta, CURRENT_TIMESTAMP);
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         6.410  END;
</SPAN></SPAN></SPAN></CODE></PRE></DIV>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">And with<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zfs_txg_timeout=1</CODE>,<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>sync=disabled</CODE><SPAN>&nbsp;</SPAN>(postgres still thinks it&#8217;s doing synchronous writes):</P>
<DIV class=highlight style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial"><PRE tabIndex=0 style='BOX-SIZING: border-box; BORDER-TOP: rgb(225,217,212) 0.5em dashed; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(225,217,212) 0.5em dashed; BORDER-BOTTOM: rgb(225,217,212) 0.5em dashed; WORD-BREAK: break-all; COLOR: rgb(85,85,85); PADDING-BOTTOM: 2em; PADDING-TOP: 2em; PADDING-LEFT: 2em; BORDER-LEFT: rgb(225,217,212) 0.5em dashed; MARGIN: 0px 0px 13px; DISPLAY: block; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 2em; BACKGROUND-COLOR: rgb(248,248,248); border-radius: 0.5em; overflow-wrap: break-word; tab-size: 4'><CODE class=language-console style='BOX-SIZING: border-box; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; WHITE-SPACE: pre-wrap; COLOR: ; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent; border-radius: 0px' data-lang="console"><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">kubectl logs job/pgbench
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">pgbench (14.1)
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">starting vacuum...end.
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">transaction type: &lt;builtin: TPC-B (sort of)&gt;
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">scaling factor: 1000
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">query mode: simple
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">number of clients: 40
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">number of threads: 4
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">duration: 300 s
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">number of transactions actually processed: 1219432
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">latency average = 9.838 ms
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">initial connection time = 98.798 ms
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">tps = 4066.023297 (without initial connection time)
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">statement latencies in milliseconds:
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.001  \set aid random(1, 100000 * :scale)
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.001  \set bid random(1, 1 * :scale)
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.001  \set tid random(1, 10 * :scale)
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.000  \set delta random(-5000, 5000)
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.640  BEGIN;
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         1.134  UPDATE pgbench_accounts SET abalance = abalance + :delta WHERE aid = :aid;
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.881  SELECT abalance FROM pgbench_accounts WHERE aid = :aid;
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.809  UPDATE pgbench_tellers SET tbalance = tbalance + :delta WHERE tid = :tid;
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.891  UPDATE pgbench_branches SET bbalance = bbalance + :delta WHERE bid = :bid;
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         0.921  INSERT INTO pgbench_history (tid, bid, aid, delta, mtime) VALUES (:tid, :bid, :aid, :delta, CURRENT_TIMESTAMP);
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">         4.553  END;
</SPAN></SPAN></SPAN></CODE></PRE></DIV>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial"><STRONG style="BOX-SIZING: border-box; FONT-WEIGHT: 700">About a ~12% improvement!</STRONG><SPAN>&nbsp;</SPAN>I&#8217;m not sure this improvement is quite worth<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">such</EM><SPAN>&nbsp;</SPAN>a drastic change &#8211;<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zfs_txg_timeout</CODE><SPAN>&nbsp;</SPAN>is set at the node level so it will affect other workloads. Again to go over the logic:</P>
<H3 id=controversial-re-convincing-myself-zfs_txg_timeout1-and-syncdisabled-is-ok-in-the-case-of-postgres style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: bold; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">(Controversial) Re-convincing myself<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zfs_txg_timeout=1</CODE><SPAN>&nbsp;</SPAN>and<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>sync=disabled</CODE><SPAN>&nbsp;</SPAN>is OK in the case of Postgres</H3>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">The Idea is that ZFS will be lying to postgres about synchronous writes speed (we&#8217;ll be essentially writing to RAM via the ARC) but since<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>txg_timeout</CODE><SPAN>&nbsp;</SPAN>means writes are flushed every second we actually only have one potential second of data loss.</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Normally, even one second of dataloss (that the upstream application thinks was written)<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">would be an issue</EM>, but since Postgres has a WAL, if we suffer a crash we will lose 1 second of data, but<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">not</EM><SPAN>&nbsp;</SPAN>completely corrupt our database.Postgres is OK with this data loss because upon restart it will replay the WAL, and ZFS cannot ever be in an inconsistent state (torn pages, etc), so there is virtually no risk outside of 1 second of data loss.</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">When postgres replays it&#8217;s WAL it will have either:</P>
<UL style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0.5em; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0.5em; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">The exact right (there were no new writes in the second before interruption) 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">An updated WAL that doesn&#8217;t match the data files (writes came in but didn&#8217;t make it to disk), these writes will be replayed 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">(impossible) Updated data files that don&#8217;t match the WAL &#8211; WAL writes go before data writes @ checkpoints</LI></UL>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">BTW if you want to join me on this dangerous journey, you can set<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zfs_txg_timeout</CODE><SPAN>&nbsp;</SPAN>via the kernel module, or temporarily by<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>echo</CODE>-ing values to<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>/sys/module/zfs/parameters/zfs_txg_timeout</CODE><SPAN>&nbsp;</SPAN>(see the docs for your distribution or<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.reddit.com/r/zfs/comments/mgibzy/where_can_i_set_the_value_of_zfs_txg_timeout/" rel=nopopener target=_blank>this reddit post</A>).</P>
<H2 id=separate-wal-writes-into-a-separate-zfs-dataset style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Separate WAL writes into a separate ZFS dataset</H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">The<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://bun.uptrace.dev/postgres/tuning-zfs-aws-ebs.html#postgresql-block-size-and-wal-size" rel=nopopener target=_blank>Bun guide</A><SPAN>&nbsp;</SPAN>covers this prfetty succinctly &#8211; by splitting the WAL off into it&#8217;s own ZFS dataset, it&#8217;s easier to take snapshots of without the rest of the data. In the end<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://pgbackrest.org/" rel=nopopener target=_blank>PGBackrest</A>,<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://pgbarman.org/" rel=nopopener target=_blank>Barman</A><SPAN>&nbsp;</SPAN>or other backup tooling are probably better to use than simply<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zfs send</CODE>/<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zfs recv</CODE><SPAN>&nbsp;</SPAN>but if you find yourself using<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zfs send</CODE>/<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>zfs recv</CODE><SPAN>&nbsp;</SPAN>then this is worth paying attention to.</P>
<H1 id=general-postgres-tuning-in-no-particular-order style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">General Postgres tuning (in no particular order)</H1>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">There are lots more tips for just general postgres, but those are mostly not covered here. Here are a few that I came across that are worth a mention. They&#8217;re not really related to PoZoL per-say but are great to take note of.</P>
<H2 id=tuning-shared_buffers style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Tuning<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>shared_buffers</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Pretty obvious of course, but<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>shared_buffers</CODE><SPAN>&nbsp;</SPAN>is a big part of tuning Postgres performance &#8211;<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.percona.com/sites/default/files/presentations/pg-Performance-Tuning.pdf" rel=nopopener target=_blank>Percona has a fantastic set of slides on it</A>.<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>shared_buffers</CODE><SPAN>&nbsp;</SPAN>is probably one of the quickest ways to more perf out there.</P>
<H2 id=tuning-work_mem style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Tuning<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>work_mem</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Another large part of tuning postgres performance which is mentioned in<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.percona.com/sites/default/files/presentations/pg-Performance-Tuning.pdf" rel=nopopener target=_blank>Percona&#8217;s set of slides on Performance tuning</A>.<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>work_mem</CODE><SPAN>&nbsp;</SPAN>is used for operations like in-memory sorting, which I think most people can spare more than the default (2MB) for!</P>
<H2 id=tuning-maintenance_work_mem style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Tuning<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>maintenance_work_mem</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Similar to<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>work_mem</CODE>,<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>maintenance_work_mem</CODE><SPAN>&nbsp;</SPAN>is used for maintenance tasks (ex.<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>VACUUM</CODE>,<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>CREATE INDEX</CODE>,<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>ALTER_TABLE</CODE>), and the default is only 64MB. I think most modern databases can afford to spare a bit more memory for such important operations. These days there are lots of things that can be done<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>CONCURRENTLY</CODE><SPAN>&nbsp;</SPAN>but this is a relatively free win in my opinion.</P>
<H2 id=tuning-wal_buffers style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Tuning<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>wal_buffers</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Increasing the amount of shared memory used for WAL data that has not been written to disk (which defaults to 16MB, w/ 8k blocks) can improve the performance of your database if you have a lot of concurrent connections. Bigger WAL can increase your concurrent performance but also makes backup/recovery take longer (bigger files to lug around) so this has to be considered.</P>
<H2 id=use-pg_repack style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Use<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>pg_repack</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Also in the<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://people.freebsd.org/~seanc/postgresql/scale15x-2017-postgresql_zfs_best_practices.pdf" rel=nopopener target=_blank>scale15x 2017 talk</A>,<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://reorg.github.io/pg_repack/" rel=nopopener target=_blank><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>pg_repack</CODE></A><SPAN>&nbsp;</SPAN>allows you to remove bloat (similar to<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>CLUSTER</CODE>/<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>VACUUM FULL</CODE>), but with the database online, without holding an exclusive lock on the processed table.</P>
<H2 id=encode-using-utf8-sort-using-c style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Encode using UTF8, sort using C</H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Another gem from the<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://people.freebsd.org/~seanc/postgresql/scale15x-2017-postgresql_zfs_best_practices.pdf" rel=nopopener target=_blank>scale15x 2017 talk</A>, the insight here is to only enable local changes when you<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">need</EM><SPAN>&nbsp;</SPAN>them.</P>
<H2 id=tuning-effective_io_concurrency style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Tuning<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>effective_io_concurrency</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">This controls the maximum<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>posix_fadvise</CODE>/<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>pread</CODE><SPAN>&nbsp;</SPAN>sequences generated by a query &#8211; tuning this should help you avoid stalls and encourage concurrent IO.</P>
<H2 id=tuning-max_connections style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Tuning<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>max_connections</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Obviously, you&#8217;re going to want to manage<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>max_connections</CODE><SPAN>&nbsp;</SPAN>&#8211; the default is 100 (with 3 reserved for super users). There&#8217;s some nuance here in<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">how</EM><SPAN>&nbsp;</SPAN>you should tune it, and<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.cybertec-postgresql.com/en/tuning-max_connections-in-postgresql/" rel=nopopener target=_blank>CYBERTEC has a great post on that</A></P>
<H2 id=tuning-effective_cache_size style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Tuning<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>effective_cache_size</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Giving Postgres hints on the size of the kernel&#8217;s disk buffer cache (and ZFS ARC) can also improve the heuristics and statistics that Postgres will use internally.</P>
<H1 id=bonus-what-discovering-silent-fdatasync-data-corruption-looks-like style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Bonus: What discovering silent<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>fdatasync</CODE><SPAN>&nbsp;</SPAN>data corruption looks like</H1>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Alternatively, how to discover that volatile cache writebacks can bite you on consumer-grade hardware.</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">When I tried out a lot of these tips, I quickly found out that<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>fdatasync</CODE><SPAN>&nbsp;</SPAN>wasn&#8217;t going to work for me, by running into database corruption with<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">just</EM><SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>pgbench</CODE>. Leaving<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>shared_buffers</CODE><SPAN>&nbsp;</SPAN>set to the default value made the corruption pretty easy to trigger. Here&#8217;s what the logs look like:</P><DETAILS style="BOX-SIZING: border-box; FONT-SIZE: 20px; BORDER-TOP: rgb(170,170,170) 1px solid; FONT-FAMILY: sans-serif; BORDER-RIGHT: rgb(170,170,170) 1px solid; WHITE-SPACE: normal; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(170,170,170) 1px solid; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); PADDING-BOTTOM: 0px; FONT-STYLE: normal; PADDING-TOP: 0.5em; PADDING-LEFT: 0.5em; BORDER-LEFT: rgb(170,170,170) 1px solid; ORPHANS: 2; WIDOWS: 2; DISPLAY: block; LETTER-SPACING: normal; PADDING-RIGHT: 0.5em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; border-radius: 4px"><SUMMARY style="BOX-SIZING: border-box; FONT-WEIGHT: bold; PADDING-BOTTOM: 0.5em; PADDING-TOP: 0.5em; PADDING-LEFT: 0.5em; MARGIN: -0.5em -0.5em 0px; DISPLAY: block; PADDING-RIGHT: 0.5em">&#55357;&#56540;&#65039; Postgres block read error output (click to expand)</SUMMARY> 
<DIV class=highlight style="BOX-SIZING: border-box"><PRE tabIndex=0 style='BOX-SIZING: border-box; BORDER-TOP: medium none; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; WORD-BREAK: break-all; COLOR: rgb(85,85,85); PADDING-BOTTOM: 2em; PADDING-TOP: 2em; PADDING-LEFT: 2em; BORDER-LEFT: medium none; MARGIN: 0px 0px 13px; DISPLAY: block; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 2em; BACKGROUND-COLOR: rgb(248,248,248); border-radius: 0.5em; overflow-wrap: break-word; tab-size: 4'><CODE class=language-console style='BOX-SIZING: border-box; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; WHITE-SPACE: pre-wrap; COLOR: ; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent; border-radius: 0px' data-lang="console"><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN></CODE></PRE></DIV></DETAILS>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">When I saw these messages at first I was really confused because of course the only thing that these messages point to is database corruption, and all I was doing was running dinky old<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>pgbench</CODE>! A few resources pointed me in a few directions:</P>
<UL style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0.5em; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0.5em; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.postgresql.org/message-id/CAA-aLv6Dp_ZsV-44QA-2zgkqWKQq%3DGedBX2dRSrWpxqovXK%3DPg%40mail.gmail.com" rel=nopopener target=_blank>https://www.postgresql.org/message-id/CAA-aLv6Dp_ZsV-44QA-2zgkqWKQq%3DGedBX2dRSrWpxqovXK%3DPg%40mail.gmail.com</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://github.com/LiskHQ/lisk-sdk/issues/268" rel=nopopener target=_blank>https://github.com/LiskHQ/lisk-sdk/issues/268</A><SPAN>&nbsp;</SPAN>(leads to an issue with their logic/transactions?) 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://dba.stackexchange.com/questions/44508/error-could-not-read-block-x-of-relation-base-y-z" rel=nopopener target=_blank>https://dba.stackexchange.com/questions/44508/error-could-not-read-block-x-of-relation-base-y-z</A></LI></UL>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">And all roads lead to ~Rome~ database corruption. At first I suspected<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>mdraid</CODE><SPAN>&nbsp;</SPAN>since that&#8217;s where I was running the tests at the time (to test against ZFS) so I ran it some more:</P><DETAILS style="BOX-SIZING: border-box; FONT-SIZE: 20px; BORDER-TOP: rgb(170,170,170) 1px solid; FONT-FAMILY: sans-serif; BORDER-RIGHT: rgb(170,170,170) 1px solid; WHITE-SPACE: normal; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(170,170,170) 1px solid; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); PADDING-BOTTOM: 0px; FONT-STYLE: normal; PADDING-TOP: 0.5em; PADDING-LEFT: 0.5em; BORDER-LEFT: rgb(170,170,170) 1px solid; ORPHANS: 2; WIDOWS: 2; DISPLAY: block; LETTER-SPACING: normal; PADDING-RIGHT: 0.5em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; border-radius: 4px"><SUMMARY style="BOX-SIZING: border-box; FONT-WEIGHT: bold; PADDING-BOTTOM: 0.5em; PADDING-TOP: 0.5em; PADDING-LEFT: 0.5em; MARGIN: -0.5em -0.5em 0px; DISPLAY: block; PADDING-RIGHT: 0.5em">&#55357;&#56540;&#65039; more Postgres block read error output (click to expand)</SUMMARY> 
<DIV class=highlight style="BOX-SIZING: border-box"><PRE tabIndex=0 style='BOX-SIZING: border-box; BORDER-TOP: medium none; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; WORD-BREAK: break-all; COLOR: rgb(85,85,85); PADDING-BOTTOM: 2em; PADDING-TOP: 2em; PADDING-LEFT: 2em; BORDER-LEFT: medium none; MARGIN: 0px 0px 13px; DISPLAY: block; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 2em; BACKGROUND-COLOR: rgb(248,248,248); border-radius: 0.5em; overflow-wrap: break-word; tab-size: 4'><CODE class=language-console style='BOX-SIZING: border-box; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; WHITE-SPACE: pre-wrap; COLOR: ; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent; border-radius: 0px' data-lang="console"><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN></CODE></PRE></DIV></DETAILS>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Well that&#8217;s not good &#8211; the errors actually<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">still</EM><SPAN>&nbsp;</SPAN>happens on ZFS, which is what<SPAN>&nbsp;</SPAN><STRONG style="BOX-SIZING: border-box; FONT-WEIGHT: 700">tipped me off to this being a underlying hardware problem</STRONG>. ZFS was protecting me a bit more than I thought (due to the ARC absorbing some load) &#8211; the problem definitely happens a lot more, and it looks increasingly clear that it is likely filesystem corruption.</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Well luckily for me the Postgres Wiki has<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://wiki.postgresql.org/wiki/Corruption" rel=nopopener target=_blank>a page on Corruption</A>, so I took a look through there and thought if there were any things there that could have been issues&#8230; Defective CPU or RAM didn&#8217;t seem to be the case (I didn&#8217;t have ECC RAM in the server but I ran some checks on the RAM and they seemed fine, the tests also consistently failed across machines).</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">At the very least the fact that it was happening on<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">both</EM><SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>mdraid</CODE><SPAN>&nbsp;</SPAN>and ZFS was a good sign that it wasn&#8217;t the ZFS subsystem and it wasn&#8217;t<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>mdraid</CODE><SPAN>&nbsp;</SPAN>in particular. The problem seemed to be &#8220;masked&#8221; by<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>shared_buffers</CODE><SPAN>&nbsp;</SPAN>so I made<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.reddit.com/r/PostgreSQL/comments/r5kdpo/pg_on_different_storage_mediums_shared_buffers/" rel=nopopener target=_blank>a reddit post</A><SPAN>&nbsp;</SPAN>and got some great help from the community.</P><DETAILS style="BOX-SIZING: border-box; FONT-SIZE: 20px; BORDER-TOP: rgb(170,170,170) 1px solid; FONT-FAMILY: sans-serif; BORDER-RIGHT: rgb(170,170,170) 1px solid; WHITE-SPACE: normal; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(170,170,170) 1px solid; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); PADDING-BOTTOM: 0px; FONT-STYLE: normal; PADDING-TOP: 0.5em; PADDING-LEFT: 0.5em; BORDER-LEFT: rgb(170,170,170) 1px solid; ORPHANS: 2; WIDOWS: 2; DISPLAY: block; LETTER-SPACING: normal; PADDING-RIGHT: 0.5em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; border-radius: 4px"><SUMMARY style="BOX-SIZING: border-box; FONT-WEIGHT: bold; PADDING-BOTTOM: 0.5em; PADDING-TOP: 0.5em; PADDING-LEFT: 0.5em; MARGIN: -0.5em -0.5em 0px; DISPLAY: block; PADDING-RIGHT: 0.5em">&#55357;&#56540;&#65039; pgbench error output (click to expand)</SUMMARY> 
<DIV class=highlight style="BOX-SIZING: border-box"><PRE tabIndex=0 style='BOX-SIZING: border-box; BORDER-TOP: medium none; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; WORD-BREAK: break-all; COLOR: rgb(85,85,85); PADDING-BOTTOM: 2em; PADDING-TOP: 2em; PADDING-LEFT: 2em; BORDER-LEFT: medium none; MARGIN: 0px 0px 13px; DISPLAY: block; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 2em; BACKGROUND-COLOR: rgb(248,248,248); border-radius: 0.5em; overflow-wrap: break-word; tab-size: 4'><CODE class=language-console style='BOX-SIZING: border-box; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; WHITE-SPACE: pre-wrap; COLOR: ; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent; border-radius: 0px' data-lang="console"><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN></CODE></PRE></DIV></DETAILS>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">With some of the error messages I could directly see the statements that were failing and they seemed like<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">very</EM><SPAN>&nbsp;</SPAN>average statements so I started to get a bit worried. The next thing I tried was downgrading to PG 13, thinking I might have found a Postgres bug as version 14.1 was very new (of course not). The logs were very similar:</P><DETAILS style="BOX-SIZING: border-box; FONT-SIZE: 20px; BORDER-TOP: rgb(170,170,170) 1px solid; FONT-FAMILY: sans-serif; BORDER-RIGHT: rgb(170,170,170) 1px solid; WHITE-SPACE: normal; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(170,170,170) 1px solid; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); PADDING-BOTTOM: 0px; FONT-STYLE: normal; PADDING-TOP: 0.5em; PADDING-LEFT: 0.5em; BORDER-LEFT: rgb(170,170,170) 1px solid; ORPHANS: 2; WIDOWS: 2; DISPLAY: block; LETTER-SPACING: normal; PADDING-RIGHT: 0.5em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; border-radius: 4px"><SUMMARY style="BOX-SIZING: border-box; FONT-WEIGHT: bold; PADDING-BOTTOM: 0.5em; PADDING-TOP: 0.5em; PADDING-LEFT: 0.5em; MARGIN: -0.5em -0.5em 0px; DISPLAY: block; PADDING-RIGHT: 0.5em">&#55357;&#56540;&#65039; Postgres container output (click to expand)</SUMMARY> 
<DIV class=highlight style="BOX-SIZING: border-box"><PRE tabIndex=0 style='BOX-SIZING: border-box; BORDER-TOP: medium none; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; WORD-BREAK: break-all; COLOR: rgb(85,85,85); PADDING-BOTTOM: 2em; PADDING-TOP: 2em; PADDING-LEFT: 2em; BORDER-LEFT: medium none; MARGIN: 0px 0px 13px; DISPLAY: block; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 2em; BACKGROUND-COLOR: rgb(248,248,248); border-radius: 0.5em; overflow-wrap: break-word; tab-size: 4'><CODE class=language-console style='BOX-SIZING: border-box; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; WHITE-SPACE: pre-wrap; COLOR: ; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent; border-radius: 0px' data-lang="console"><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN><SPAN style="BOX-SIZING: border-box; COLOR: rgb(164,0,0)"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(164,0,0)"></SPAN><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic"></SPAN></SPAN></SPAN></CODE></PRE></DIV></DETAILS>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Very curiously ,the folder seemed to be stuck at around 16GB before the errors would show up.</P>
<H2 id=fake-resolution-bigger-shared_buffers style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Fake resolution: Bigger<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>shared_buffers</CODE></H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Generally shared_buffers should be 25% of RAM it seems&#8230; the nodes did have 16GB of RAM so 4GB would be what to set it to. The runs would complete with<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>shared_buffers</CODE><SPAN>&nbsp;</SPAN>set to 4GB (but<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">thankfully</EM><SPAN>&nbsp;</SPAN>I didn&#8217;t stop there) &#8211; obviously, a lack of memory space (<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>shared_buffers</CODE>) should not cause a database like Postgres to los integrity. I may have found a workaround but something is fundamentally wrong.</P>
<H2 id=dead-end-max_wal_size- style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Dead end:<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>max_wal_size</CODE><SPAN>&nbsp;</SPAN>?</H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Increasing the max_wal_size to 4096 (4GB) also delayed the problem but didn&#8217;t fix it &#8211;<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>pgbench</CODE><SPAN>&nbsp;</SPAN>runs were still failing. Looking at<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>max_wal_size</CODE><SPAN>&nbsp;</SPAN>did give me an idea though &#8211; maybe I was running out of some kind of resource?</P>
<H2 id=dead-end-ulimit style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Dead end: ulimit?</H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">I started thinking that maybe I was hitting some file system limit, so I checked<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>ulimit -a</CODE>:</P>
<DIV class=highlight style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial"><PRE tabIndex=0 style='BOX-SIZING: border-box; BORDER-TOP: rgb(225,217,212) 0.5em dashed; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(225,217,212) 0.5em dashed; BORDER-BOTTOM: rgb(225,217,212) 0.5em dashed; WORD-BREAK: break-all; COLOR: rgb(85,85,85); PADDING-BOTTOM: 2em; PADDING-TOP: 2em; PADDING-LEFT: 2em; BORDER-LEFT: rgb(225,217,212) 0.5em dashed; MARGIN: 0px 0px 13px; DISPLAY: block; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 2em; BACKGROUND-COLOR: rgb(248,248,248); border-radius: 0.5em; overflow-wrap: break-word; tab-size: 4'><CODE class=language-console style='BOX-SIZING: border-box; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; WHITE-SPACE: pre-wrap; COLOR: ; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent; border-radius: 0px' data-lang="console"><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">root@node-2 ~ # ulimit -a
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">core file size          (blocks, -c) 0
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">data seg size           (kbytes, -d) unlimited
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">scheduling priority             (-e) 0
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">file size               (blocks, -f) unlimited
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">pending signals                 (-i) 255813
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">max locked memory       (kbytes, -l) 65536
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">max memory size         (kbytes, -m) unlimited
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">open files                      (-n) 1024
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">pipe size            (512 bytes, -p) 8
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">POSIX message queues     (bytes, -q) 819200
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">real-time priority              (-r) 0
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">stack size              (kbytes, -s) 8192
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">cpu time               (seconds, -t) unlimited
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">max user processes              (-u) 255813
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">virtual memory          (kbytes, -v) unlimited
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">file locks                      (-x) unlimited
</SPAN></SPAN></SPAN></CODE></PRE></DIV>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">And the &#8220;real&#8221; usage during<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>pgbench</CODE><SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">seemed</EM><SPAN>&nbsp;</SPAN>to be:</P>
<DIV class=highlight style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial"><PRE tabIndex=0 style='BOX-SIZING: border-box; BORDER-TOP: rgb(225,217,212) 0.5em dashed; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(225,217,212) 0.5em dashed; BORDER-BOTTOM: rgb(225,217,212) 0.5em dashed; WORD-BREAK: break-all; COLOR: rgb(85,85,85); PADDING-BOTTOM: 2em; PADDING-TOP: 2em; PADDING-LEFT: 2em; BORDER-LEFT: rgb(225,217,212) 0.5em dashed; MARGIN: 0px 0px 13px; DISPLAY: block; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 2em; BACKGROUND-COLOR: rgb(248,248,248); border-radius: 0.5em; overflow-wrap: break-word; tab-size: 4'><CODE class=language-console style='BOX-SIZING: border-box; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; WHITE-SPACE: pre-wrap; COLOR: ; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent; border-radius: 0px' data-lang="console"><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">root@node-2 ~ # cat /proc/sys/fs/file-nr
</SPAN></SPAN></SPAN><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(0,0,0); FONT-STYLE: italic">50112   0       9223372036854775807
</SPAN></SPAN></SPAN></CODE></PRE></DIV>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Based on this I thought maybe the open files limit was the issue, but then I checked the<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>max</CODE>:</P><PRE tabIndex=0 style='BOX-SIZING: border-box; BORDER-TOP: rgb(225,217,212) 0.5em dashed; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(225,217,212) 0.5em dashed; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(225,217,212) 0.5em dashed; TEXT-TRANSFORM: none; WORD-BREAK: break-all; FONT-WEIGHT: 400; COLOR: rgb(85,85,85); PADDING-BOTTOM: 2em; FONT-STYLE: normal; PADDING-TOP: 2em; PADDING-LEFT: 2em; BORDER-LEFT: rgb(225,217,212) 0.5em dashed; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 13px; DISPLAY: block; LETTER-SPACING: normal; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 2em; BACKGROUND-COLOR: rgb(249,245,242); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; border-radius: 0.5em; overflow-wrap: break-word'><CODE style='BOX-SIZING: border-box; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; WHITE-SPACE: pre-wrap; COLOR: ; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent; border-radius: 0px'>root@node-2 ~ # sysctl fs.file-max
fs.file-max = 9223372036854775807
</CODE></PRE>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Well&#8230; It looks like the limit is<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">not</EM><SPAN>&nbsp;</SPAN>the issue. In fact, you can actually check by a specific process and find out what the limits are and get the right values (which are set by container orchestration tooling):</P><PRE tabIndex=0 style='BOX-SIZING: border-box; BORDER-TOP: rgb(225,217,212) 0.5em dashed; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(225,217,212) 0.5em dashed; WORD-SPACING: 0px; BORDER-BOTTOM: rgb(225,217,212) 0.5em dashed; TEXT-TRANSFORM: none; WORD-BREAK: break-all; FONT-WEIGHT: 400; COLOR: rgb(85,85,85); PADDING-BOTTOM: 2em; FONT-STYLE: normal; PADDING-TOP: 2em; PADDING-LEFT: 2em; BORDER-LEFT: rgb(225,217,212) 0.5em dashed; ORPHANS: 2; WIDOWS: 2; MARGIN: 0px 0px 13px; DISPLAY: block; LETTER-SPACING: normal; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 2em; BACKGROUND-COLOR: rgb(249,245,242); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; border-radius: 0.5em; overflow-wrap: break-word'><CODE style='BOX-SIZING: border-box; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; WHITE-SPACE: pre-wrap; COLOR: ; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent; border-radius: 0px'>root@node-2 ~ # ulimit -n 65536
root@node-2 ~ # ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 255813
max locked memory       (kbytes, -l) 65536
max memory size         (kbytes, -m) unlimited
open files                      (-n) 65536
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 255813
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
</CODE></PRE>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Clearly no problem there.</P>
<H2 id=solution-force-proper-disk-syncing style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Solution: Force proper disk syncing</H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">The insight came from<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.reddit.com/r/PostgreSQL/comments/r5kdpo/pg_on_different_storage_mediums_shared_buffers/hmxxs88/" rel=nopopener target=_blank>/u/nikowek on reddit</A><SPAN>&nbsp;</SPAN>&#8211; the lost writes (that couldn&#8217;t be read back) coupled with<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">absolutely no feedback</EM><SPAN>&nbsp;</SPAN>from the Kernel or Postgres itself on writes failing means that the drives below<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">must</EM><SPAN>&nbsp;</SPAN>have been reporting writes successful when they<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">weren&#8217;t</EM>.</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">It looks like I&#8217;d run head first into a feature of the drives below that wasn&#8217;t quite working as I&#8217;d expected &#8211; the &#8220;Volatile cache&#8221; write cache is to blame (there&#8217;s a great post on this in<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://techcommunity.microsoft.com/t5/storage-at-microsoft/don-t-do-it-consumer-grade-solid-state-drives-ssd-in-storage/ba-p/425914" rel=nopopener target=_blank>some microsoft forums</A>).</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">As this is the problem, there are only two easy ways around it:</P>
<UL style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0.5em; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0.5em; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>wal_sync_method=fsync</CODE><SPAN>&nbsp;</SPAN>at the postgres level (instead of<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>fdatasync</CODE>) 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">Disable write back cache at the drive level with (<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>apt install nvme-cli</CODE>)</LI></UL>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Since I don&#8217;t<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">ever</EM><SPAN>&nbsp;</SPAN>want to run into this problem again (at least until I upgrade to enterprise HDDs across the board, I guess), I&#8217;ve gone with the second one &#8211; which is disabling the volatile write cache at the drive level:</P>
<DIV class=highlight style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial"><PRE tabIndex=0 style='BOX-SIZING: border-box; BORDER-TOP: rgb(225,217,212) 0.5em dashed; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; BORDER-RIGHT: rgb(225,217,212) 0.5em dashed; BORDER-BOTTOM: rgb(225,217,212) 0.5em dashed; WORD-BREAK: break-all; COLOR: rgb(85,85,85); PADDING-BOTTOM: 2em; PADDING-TOP: 2em; PADDING-LEFT: 2em; BORDER-LEFT: rgb(225,217,212) 0.5em dashed; MARGIN: 0px 0px 13px; DISPLAY: block; LINE-HEIGHT: 1.4285; PADDING-RIGHT: 2em; BACKGROUND-COLOR: rgb(248,248,248); border-radius: 0.5em; overflow-wrap: break-word; tab-size: 4'><CODE class=language-console style='BOX-SIZING: border-box; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; WHITE-SPACE: pre-wrap; COLOR: ; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent; border-radius: 0px' data-lang="console"><SPAN style="BOX-SIZING: border-box; DISPLAY: flex"><SPAN style="BOX-SIZING: border-box"><SPAN style="BOX-SIZING: border-box; COLOR: rgb(143,89,2)">$</SPAN> nvme set-feature -f <SPAN style="BOX-SIZING: border-box; FONT-WEIGHT: bold; COLOR: rgb(0,0,207)">6</SPAN> -v <SPAN style="BOX-SIZING: border-box; FONT-WEIGHT: bold; COLOR: rgb(0,0,207)">0</SPAN> /dev/nvme0n1
</SPAN></SPAN></CODE></PRE></DIV>
<H2 id=same-same-but-different-longhorn-has-the-same-issue style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Same same, but different: Longhorn has the same issue</H2>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">While I was here, I ran the<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>pgbench</CODE><SPAN>&nbsp;</SPAN>tests against a postgres instance with storage backed by my<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://longhorn.io/docs" rel=nopopener target=_blank>Longhorn</A><SPAN>&nbsp;</SPAN>installation. I was instantly suspicious because the Longhorn runs actually ran<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">as fast as</EM><SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>mdraid</CODE><SPAN>&nbsp;</SPAN>and ZFS runs which just can&#8217;t be right &#8211; Longhorn performs<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">synchronous</EM><SPAN>&nbsp;</SPAN>remote writes &#8211; there&#8217;s no way the performace should be at par with local-only disk writes, even with increased<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>shared_buffers</CODE><SPAN>&nbsp;</SPAN>size.</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Once I reduced the size of<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>shared_buffers</CODE><SPAN>&nbsp;</SPAN>the issue presented itself (I guess<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>longhorn</CODE><SPAN>&nbsp;</SPAN>uses<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>fdatasync</CODE><SPAN>&nbsp;</SPAN>or one of the other options underneath?), so<SPAN>&nbsp;</SPAN><STRONG style="BOX-SIZING: border-box; FONT-WEIGHT: 700">the right way to fix the problem was indeed disabling the volatile write cache at the drive.</STRONG></P>
<H1 id=all-the-links style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">All the links</H1>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Here&#8217;s all the sources so you can look for yourself. Thanks to all these people for sharing their wealth of knowledge. Special thanks to /u/mercenary_sysadmin on Reddit and all the comitters and contributors on the Postgres and ZFS mailing lists.</P>
<UL style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0.5em; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0.5em; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://people.freebsd.org/~seanc/postgresql/scale15x-2017-postgresql_zfs_best_practices.pdf" rel=nopopener target=_blank>Slides from a PoZoL presentation at Scale15x Conference in 2017</A><SPAN>&nbsp;</SPAN>(<A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.youtube.com/watch?v=dwMQXLOXUco&amp;t=5560s" rel=nopopener target=_blank>Talk on Youtube</A>) 
<UL style="BOX-SIZING: border-box; MARGIN-BOTTOM: 0.5em; MARGIN-TOP: 0.5em">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://lobste.rs/s/ux1gik/postgresql_zfs_best_practices_standard" rel=nopopener target=_blank>Lobster.rs discussion</A></LI></UL>
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://bun.uptrace.dev/postgres/tuning-zfs-aws-ebs.html#postgresql-block-size-and-wal-size" rel=nopopener target=_blank>Bun&#8217;s post on Postgres on ZFS on AWS</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://papers.freebsd.org/2020/BSDcan/munro-PostgreSQL_on_FreeBSD.files/munro-PostgreSQL_on_FreeBSD.pdf" rel=nopopener target=_blank>Thomas Munro&#8217;s paper on Postgres for FreeBSD</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.slideshare.net/GrantMcAlister/tuning-postgresql-for-high-write-throughput" rel=nopopener target=_blank>Grant McAlister&#8217;s talk on tuning Postgres for High Write Throughput</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.percona.com/sites/default/files/presentations/pg-Performance-Tuning.pdf" rel=nopopener target=_blank>Percona&#8217;s presentation on Postgres Performance Tuning</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://dan.langille.org/2013/02/15/zfs-tuning-2/" rel=nopopener target=_blank>Dan Langille&#8217;s post on ZFS tuning</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.percona.com/blog/mysql-zfs-performance-update/" rel=nopopener target=_blank>Percona&#8217;s MySQL ZFS performance<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">update</EM><SPAN>&nbsp;</SPAN>post</A><SPAN>&nbsp;</SPAN>(not Postgres but still useful!) 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.cybertec-postgresql.com/en/tuning-max_connections-in-postgresql/" rel=nopopener target=_blank>CYBERTEC&#8217;s post on tuning<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>max_connections</CODE></A></LI></UL>
<H1 id=update-20211221-way-more-links style="BOX-SIZING: border-box; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 500; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 25px 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.1; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Update (2021/12/21): Way more links</H1>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">So there are lots more links and information to read through. I got going down a rabbit hole, so I want to leave all these resources here for anyone else who wants to jump down:</P>
<UL style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0.5em; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0.5em; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.percona.com/blog/2018/05/15/about-zfs-performance/" rel=nopopener target=_blank>Percona blog: About ZFS Performance</A> 
<UL style="BOX-SIZING: border-box; MARGIN-BOTTOM: 0.5em; MARGIN-TOP: 0.5em">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">Benchmark seems to be flawed because ZFS w/ L2ARC was<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">not</EM><SPAN>&nbsp;</SPAN>compared to the equivalent for XFS (<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>bcache</CODE>) or EXT4 (<CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>dm-cache</CODE><SPAN>&nbsp;</SPAN>+/- LVM caching?) 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">Commenter called out<SPAN>&nbsp;</SPAN><CODE style='BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: Menlo, Monaco, Consolas, "Courier New", monospace; COLOR: rgb(199,37,78); PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 4px; PADDING-RIGHT: 4px; BACKGROUND-COLOR: rgb(250,250,250); border-radius: 4px'>logbias=throughput</CODE><SPAN>&nbsp;</SPAN>as terrible for causing fragmentation (just read all the quotes by &#8220;Janet Campbell&#8221;)</LI></UL>
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://iopscience.iop.org/article/10.1088/1742-6596/898/6/062054/pdf" rel=nopopener target=_blank>Paper: Evaluation of ZFS as an efficient WLCG storage backend</A> 
<UL style="BOX-SIZING: border-box; MARGIN-BOTTOM: 0.5em; MARGIN-TOP: 0.5em">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">ZFS is compared with XFS and EXT4 directly 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://indico.cern.ch/event/505613/contributions/2230928/" rel=nopopener target=_blank>Talk schedule page which comes with more PDFs</A><SPAN>&nbsp;</SPAN>(at the bottom)</LI></UL>
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.snia.org/sites/default/files/SDC/2019/presentations/File_Systems/McKenzie_Ryan_Best_Practices_for_OpenZFS_L2ARC_in_the_Era_of_NVMe.pdf" rel=nopopener target=_blank>Slides: Best Practices for OpenZFS L2ARC in the Era of NVMe by Ryan McKenzie of iXsystems</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://napp-it.org/doc/downloads/optane_slog_pool_performane.pdf" rel=nopopener target=_blank>Long Paper: napp-it ZFS storage performance tests</A> 
<UL style="BOX-SIZING: border-box; MARGIN-BOTTOM: 0.5em; MARGIN-TOP: 0.5em">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">This seems like<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">kinda</EM><SPAN>&nbsp;</SPAN>like a paid advertisement for Oracle Solaris / Intel Optane, but it has a very helfpul TL;DR.</LI></UL>
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://martin.heiland.io/2018/02/23/zfs-tuning/" rel=nopopener target=_blank>Article on ZFS tuning by Martin Heiland</A> 
<UL style="BOX-SIZING: border-box; MARGIN-BOTTOM: 0.5em; MARGIN-TOP: 0.5em">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">I think he reaches the wrong conclusion about compression here, but some interesting insights for VM workloads.</LI></UL>
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"></LI></UL>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">And here&#8217;s the rabbit hole I went down&#8230;.</P>
<UL style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0.5em; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0.5em; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.joyent.com/blog/bruning-questions-zfs-record-size" rel=nopopener target=_blank>Post: Bruning questions about ZFS record size (Max Bruning at Joyent)</A> 
<UL style="BOX-SIZING: border-box; MARGIN-BOTTOM: 0.5em; MARGIN-TOP: 0.5em">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">This post leads to the edge of the rabbit hole, which is a dead link to<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/tuning-zfs-recordsize" rel=nopopener target=_blank>An old Oracle post about tuning ZFS recordsize</A></LI></UL>
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/tuning-zfs-recordsize" rel=nopopener target=_blank>Post: Tuning ZFS Recordsize (Oracle)</A> 
<UL style="BOX-SIZING: border-box; MARGIN-BOTTOM: 0.5em; MARGIN-TOP: 0.5em">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">At this point, I went through every ZFS related post on oracle and picked out everything that looked interesting&#8230;</LI></UL>
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/zfs-and-oltp" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/zfs-and-oltp</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/zfs-write-throttle-observations" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/zfs-write-throttle-observations</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/a-hands-on-introduction-to-zfs-pools" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/a-hands-on-introduction-to-zfs-pools</A> 
<UL style="BOX-SIZING: border-box; MARGIN-BOTTOM: 0.5em; MARGIN-TOP: 0.5em">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/a-hands-on-introduction-to-zfs-pools-part-1-getting-started-zpool-create-status-import-export" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/a-hands-on-introduction-to-zfs-pools-part-1-getting-started-zpool-create-status-import-export</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/a-hands-on-introduction-to-zfs-pools-part-2-mirrors-disk-failures-and-spare-disks" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/a-hands-on-introduction-to-zfs-pools-part-2-mirrors-disk-failures-and-spare-disks</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/a-hands-on-introduction-to-zfs-pools-part-3-raidz2-scrubbing-and-resilvering" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/a-hands-on-introduction-to-zfs-pools-part-3-raidz2-scrubbing-and-resilvering</A></LI></UL>
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/zfs-compression-perf-disk-space-and-watts-the-naked-truth-part-1-of-2" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/zfs-compression-perf-disk-space-and-watts-the-naked-truth-part-1-of-2</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/zfs-compression-perf-disk-space-and-watts-the-naked-truth-part-2-of-2" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/zfs-compression-perf-disk-space-and-watts-the-naked-truth-part-2-of-2</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/understanding-the-space-used-by-zfs" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/understanding-the-space-used-by-zfs</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/zfs-compression-a-win-win" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/zfs-compression-a-win-win</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/does-zfs-really-use-more-ram" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/does-zfs-really-use-more-ram</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/the-new-zfs-write-throttle" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/the-new-zfs-write-throttle</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/the-dynamics-of-zfs" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/the-dynamics-of-zfs</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/oracle-systems/post/reducing-storage-costs-with-zfs-compression" rel=nopopener target=_blank>https://blogs.oracle.com/oracle-systems/post/reducing-storage-costs-with-zfs-compression</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/zfs-space-reporting-snapshots-clones-and-how-nfs-deals-with-it" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/zfs-space-reporting-snapshots-clones-and-how-nfs-deals-with-it</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/nfs-and-zfs-a-fine-combination" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/nfs-and-zfs-a-fine-combination</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/virtualization/post/availability-best-practices-using-a-mirrored-zfs-pool-with-virtual-disks" rel=nopopener target=_blank>https://blogs.oracle.com/virtualization/post/availability-best-practices-using-a-mirrored-zfs-pool-with-virtual-disks</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/when-to-and-not-to-use-raid-z" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/when-to-and-not-to-use-raid-z</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/zero-copy-io-aggregation" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/zero-copy-io-aggregation</A> 
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://blogs.oracle.com/solaris/post/need-inodes" rel=nopopener target=_blank>https://blogs.oracle.com/solaris/post/need-inodes</A></LI></UL>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">Another completely separate rabbit hole which looks like it holds even<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">richer</EM><SPAN>&nbsp;</SPAN>treasures is<SPAN>&nbsp;</SPAN><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://utcc.utoronto.ca/~cks/space/blog/__TopicZFS" rel=nopopener target=_blank>Chris Seibermann of UToronto&#8217;s blog posts on ZFS</A><SPAN>&nbsp;</SPAN>(thanks to /u/BucketOfSpinningRust on Reddit).</P>
<P style="BOX-SIZING: border-box; FONT-SIZE: 20px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; MARGIN: 0.75em 0px; LETTER-SPACING: normal; LINE-HEIGHT: 1.12em; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">/u/BucketOfSpinningRust on reddit also was kind enough to share some explanations of behavior on the ZFS side in two separate comments:</P>
<UL style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0.5em; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0.5em; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: rgb(255,255,255); TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.reddit.com/r/zfs/comments/rjavyc/everything_ive_seen_on_optimizing_postgres_on_zfs/hp6vrra/" rel=nopopener target=_blank>https://www.reddit.com/r/zfs/comments/rjavyc/everything_ive_seen_on_optimizing_postgres_on_zfs/hp6vrra/</A> 
<UL style="BOX-SIZING: border-box; MARGIN-BOTTOM: 0.5em; MARGIN-TOP: 0.5em">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">This was a correction of the notion that multiple pages ever go into the same &#8220;ZFS Record&#8221; &#8211; this is a mischaracterization that I parroted, what happens is that more pages will be able to<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">likely</EM><SPAN>&nbsp;</SPAN>fit in the same area of disk &#8211; compression is done<SPAN>&nbsp;</SPAN><EM style="BOX-SIZING: border-box; FONT-STYLE: italic">after</EM><SPAN>&nbsp;</SPAN>the concept of a ZFS record is gone (i.e. when you know the physical size of one or more writes in a transaction group).</LI></UL>
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px"><A style="BOX-SIZING: border-box; TEXT-DECORATION: underline; COLOR: rgb(111,145,111); BACKGROUND-COLOR: transparent; transition: 0.3s ease-in-out" href="https://www.reddit.com/r/zfs/comments/rjavyc/everything_ive_seen_on_optimizing_postgres_on_zfs/hp8u2rk/" rel=nopopener target=_blank>https://www.reddit.com/r/zfs/comments/rjavyc/everything_ive_seen_on_optimizing_postgres_on_zfs/hp8u2rk/</A> 
<UL style="BOX-SIZING: border-box; MARGIN-BOTTOM: 0.5em; MARGIN-TOP: 0.5em">
<LI style="BOX-SIZING: border-box; MARGIN-BOTTOM: 5px">Great explanation on how record size is treated, reproduced below, just in case in some weird future this site is up and Reddit isn&#8217;t (or it&#8217;s paywalled):</LI></UL></LI></UL>
<BLOCKQUOTE style="BOX-SIZING: border-box; FONT-SIZE: 20px; MARGIN-BOTTOM: 0px; FONT-FAMILY: sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); PADDING-BOTTOM: 1em; FONT-STYLE: italic; TEXT-ALIGN: justify; PADDING-TOP: 1em; PADDING-LEFT: 1em; BORDER-LEFT: green 0.25em solid; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; PADDING-RIGHT: 1em; BACKGROUND-COLOR: rgb(238,238,238); MARGIN-RIGHT: 3px; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial">
<P style="BOX-SIZING: border-box; MARGIN: 0.75em 0px; LETTER-SPACING: 0px; LINE-HEIGHT: 1.12em">Files smaller than the record size are compressed (if applicable), and then stored as unique records that physically occupy unique sectors on disk (IE round up to the nearest ashift value). With a record size of 8k (or larger), you can store a 5k file that compresses down to 3k in 4k of disk space with ashift=12. Files larger than a record size are broken into blocks of the record size, then compressed and stored, again rounding up. A 5M file with 1M records could be stored as 2 uncompressed 1M records, a 512k record, a 100k record, and another 1M record. Side note: There are some weird edge cases with very large record sizes. A &#8203;1.001M file with 1M record sizes will be stored as 2 1M records, then compressed.</P>
<P style="BOX-SIZING: border-box; MARGIN: 0.75em 0px; LETTER-SPACING: 0px; LINE-HEIGHT: 1.12em">In response to your edit: You can set your record size to some multiple of the page size in whatever database you&#8217;re using. There are some perfectly legitimate reasons to do this. Jumping to 16 and 32k records often gives you moderate bumps in compression ratios. (Going past 32k rarely gives you worthwhile benefits in my experience.) This means you can store more in the ARC and/or use less memory. It also means that you warm the cache faster which is relevant for spinning up disposable VMs for things like load balancing. For databases where you frequently read multiple adjacent pages, it acts as a form of prefetching. For exceptionally large databases that aren&#8217;t under heavy I/O load the compression can save on disk space (that&#8217;s a rare usage case admittedly).</P>
<P style="BOX-SIZING: border-box; MARGIN: 0.75em 0px; LETTER-SPACING: 0px; LINE-HEIGHT: 1.12em">The catch is write amplification, or even worse, read modify writes. Write amplification itself isn&#8217;t always a major issue on rust because the limiting factor is seek time. The difference between doing 4, 8, 16 and 32k writes is fairly small in terms of IOPS. Yeah, you can do fewer operations with larger writes because the head needs to spend longer writing (duh), but the time spent writing on full random workloads is somewhat trivial compared to the time the head spends moving around. What usually fucks your performance when oversizing is read modify writes. If everything is cached in RAM, yeah you&#8217;re using a bit of extra memory throughput and burning some CPU time doing compression, checksums, etc, but that often doesn&#8217;t matter. What matters is disk throughput. If oversizing records gives you better compression to fit more stuff, or your workload does enough adjacent reads to make the pseudo prefetching give you better ARC hit rates, you can actually reduce disk usage.</P>
<P style="BOX-SIZING: border-box; MARGIN: 0.75em 0px 0px; LETTER-SPACING: 0px; LINE-HEIGHT: 1.12em">It&#8217;s a balancing act. Time spent reading off of rust is time that cannot be spent writing to disk, and vice versa. Oversizing ZFS records can reduce the number of reads going to disk, which can result in increased performance, but if you go too far it&#8217;s very easy to completely tank your performance.</P></BLOCKQUOTE>