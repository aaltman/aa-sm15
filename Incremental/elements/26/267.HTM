<b> : </b>30.6.&nbsp;WAL Internals<SPAN>&nbsp;</SPAN><A class=id_link style="BOX-SIZING: border-box; TEXT-DECORATION: none; FONT-WEIGHT: 600; COLOR: ; VISIBILITY: hidden; BACKGROUND-COLOR: transparent; transition: color 0.2s ease-in-out" href="https://www.postgresql.org/docs/current/wal-internals.html#WAL-INTERNALS"></A></H2></DIV></DIV></DIV><A id=id-1.6.17.8.2 class=indexterm style='BOX-SIZING: border-box; FONT-SIZE: 14px; TEXT-DECORATION: none; FONT-FAMILY: "Open Sans", sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 600; COLOR:  !important; FONT-STYLE: normal; TEXT-ALIGN: left; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; BACKGROUND-COLOR: transparent; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; transition: color 0.2s ease-in-out' name=id-1.6.17.8.2></A><SPAN style='FONT-SIZE: 14px; FONT-FAMILY: "Open Sans", sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; TEXT-TRANSFORM: none; FLOAT: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; TEXT-ALIGN: left; ORPHANS: 2; WIDOWS: 2; DISPLAY: inline !important; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'></SPAN>
<P style='BOX-SIZING: border-box; FONT-SIZE: 14px; FONT-FAMILY: "Open Sans", sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; TEXT-ALIGN: left; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'><ACRONYM class=acronym style="BOX-SIZING: border-box">WAL</ACRONYM><SPAN>&nbsp;</SPAN>is automatically enabled; no action is required from the administrator except ensuring that the disk-space requirements for the<SPAN>&nbsp;</SPAN><ACRONYM class=acronym style="BOX-SIZING: border-box">WAL</ACRONYM><SPAN>&nbsp;</SPAN>files are met, and that any necessary tuning is done (see<SPAN>&nbsp;</SPAN><A title="30.5.&nbsp;WAL Configuration" class=xref style="BOX-SIZING: border-box; TEXT-DECORATION: none; FONT-WEIGHT: 600; COLOR: ; BACKGROUND-COLOR: transparent; transition: color 0.2s ease-in-out" href="https://www.postgresql.org/docs/current/wal-configuration.html">Section&nbsp;30.5</A>).</P>
<P style='BOX-SIZING: border-box; FONT-SIZE: 14px; FONT-FAMILY: "Open Sans", sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; TEXT-ALIGN: left; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'><ACRONYM class=acronym style="BOX-SIZING: border-box">WAL</ACRONYM><SPAN>&nbsp;</SPAN>records are appended to the<SPAN>&nbsp;</SPAN><ACRONYM class=acronym style="BOX-SIZING: border-box">WAL</ACRONYM><SPAN>&nbsp;</SPAN>files as each new record is written. The insert position is described by a Log Sequence Number (<ACRONYM class=acronym style="BOX-SIZING: border-box">LSN</ACRONYM>) that is a byte offset into the WAL, increasing monotonically with each new record.<SPAN>&nbsp;</SPAN><ACRONYM class=acronym style="BOX-SIZING: border-box">LSN</ACRONYM><SPAN>&nbsp;</SPAN>values are returned as the datatype<SPAN>&nbsp;</SPAN><A title="8.20.&nbsp;pg_lsn Type" class=link style="BOX-SIZING: border-box; TEXT-DECORATION: none; FONT-WEIGHT: 600; COLOR: ; BACKGROUND-COLOR: transparent; transition: color 0.2s ease-in-out" href="https://www.postgresql.org/docs/current/datatype-pg-lsn.html"><CODE class=type style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR: ; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">pg_lsn</CODE></A>. Values can be compared to calculate the volume of<SPAN>&nbsp;</SPAN><ACRONYM class=acronym style="BOX-SIZING: border-box">WAL</ACRONYM><SPAN>&nbsp;</SPAN>data that separates them, so they are used to measure the progress of replication and recovery.</P>
<P style='BOX-SIZING: border-box; FONT-SIZE: 14px; FONT-FAMILY: "Open Sans", sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; TEXT-ALIGN: left; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'><ACRONYM class=acronym style="BOX-SIZING: border-box">WAL</ACRONYM><SPAN>&nbsp;</SPAN>files are stored in the directory<SPAN>&nbsp;</SPAN><CODE class=filename style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">pg_wal</CODE><SPAN>&nbsp;</SPAN>under the data directory, as a set of segment files, normally each 16 MB in size (but the size can be changed by altering the<SPAN>&nbsp;</SPAN><CODE class=option style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">--wal-segsize</CODE><SPAN>&nbsp;</SPAN><SPAN class=application style="BOX-SIZING: border-box">initdb</SPAN><SPAN>&nbsp;</SPAN>option). Each segment is divided into pages, normally 8 kB each (this size can be changed via the<SPAN>&nbsp;</SPAN><CODE class=option style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">--with-wal-blocksize</CODE><SPAN>&nbsp;</SPAN>configure option). The WAL record headers are described in<SPAN>&nbsp;</SPAN><CODE class=filename style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">access/xlogrecord.h</CODE>; the record content is dependent on the type of event that is being logged. Segment files are given ever-increasing numbers as names, starting at<SPAN>&nbsp;</SPAN><CODE class=filename style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">000000010000000000000001</CODE>. The numbers do not wrap, but it will take a very, very long time to exhaust the available stock of numbers.</P>
<P style='BOX-SIZING: border-box; FONT-SIZE: 14px; FONT-FAMILY: "Open Sans", sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; TEXT-ALIGN: left; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'>It is advantageous if the WAL is located on a different disk from the main database files. This can be achieved by moving the<SPAN>&nbsp;</SPAN><CODE class=filename style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">pg_wal</CODE><SPAN>&nbsp;</SPAN>directory to another location (while the server is shut down, of course) and creating a symbolic link from the original location in the main data directory to the new location.</P>
<P style='BOX-SIZING: border-box; FONT-SIZE: 14px; FONT-FAMILY: "Open Sans", sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; TEXT-ALIGN: left; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'>The aim of<SPAN>&nbsp;</SPAN><ACRONYM class=acronym style="BOX-SIZING: border-box">WAL</ACRONYM><SPAN>&nbsp;</SPAN>is to ensure that the log is written before database records are altered, but this can be subverted by disk drives<A id=id-1.6.17.8.7.2 class=indexterm style="BOX-SIZING: border-box; TEXT-DECORATION: none; FONT-WEIGHT: 600; COLOR:  !important; BACKGROUND-COLOR: transparent; transition: color 0.2s ease-in-out" name=id-1.6.17.8.7.2></A><SPAN>&nbsp;</SPAN>that falsely report a successful write to the kernel, when in fact they have only cached the data and not yet stored it on the disk. A power failure in such a situation might lead to irrecoverable data corruption. Administrators should try to ensure that disks holding<SPAN>&nbsp;</SPAN><SPAN class=productname style="BOX-SIZING: border-box">PostgreSQL</SPAN>'s<SPAN>&nbsp;</SPAN><ACRONYM class=acronym style="BOX-SIZING: border-box">WAL</ACRONYM><SPAN>&nbsp;</SPAN>files do not make such false reports. (See<SPAN>&nbsp;</SPAN><A title=30.1.&nbsp;Reliability class=xref style="BOX-SIZING: border-box; TEXT-DECORATION: none; FONT-WEIGHT: 600; COLOR: ; BACKGROUND-COLOR: transparent; transition: color 0.2s ease-in-out" href="https://www.postgresql.org/docs/current/wal-reliability.html">Section&nbsp;30.1</A>.)</P>
<P style='BOX-SIZING: border-box; FONT-SIZE: 14px; FONT-FAMILY: "Open Sans", sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; TEXT-ALIGN: left; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'>After a checkpoint has been made and the WAL flushed, the checkpoint's position is saved in the file<SPAN>&nbsp;</SPAN><CODE class=filename style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">pg_control</CODE>. Therefore, at the start of recovery, the server first reads<SPAN>&nbsp;</SPAN><CODE class=filename style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">pg_control</CODE><SPAN>&nbsp;</SPAN>and then the checkpoint record; then it performs the REDO operation by scanning forward from the WAL location indicated in the checkpoint record. Because the entire content of data pages is saved in the WAL on the first page modification after a checkpoint (assuming<SPAN>&nbsp;</SPAN><A class=xref style="BOX-SIZING: border-box; TEXT-DECORATION: none; FONT-WEIGHT: 600; COLOR: ; BACKGROUND-COLOR: transparent; transition: color 0.2s ease-in-out" href="https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-FULL-PAGE-WRITES">full_page_writes</A><SPAN>&nbsp;</SPAN>is not disabled), all pages changed since the checkpoint will be restored to a consistent state.</P>
<P style='BOX-SIZING: border-box; FONT-SIZE: 14px; FONT-FAMILY: "Open Sans", sans-serif; WHITE-SPACE: normal; WORD-SPACING: 0px; MARGIN-TOP: 0px; TEXT-TRANSFORM: none; FONT-WEIGHT: 400; COLOR: rgb(0,0,0); FONT-STYLE: normal; TEXT-ALIGN: left; ORPHANS: 2; WIDOWS: 2; LETTER-SPACING: normal; TEXT-INDENT: 0px; font-variant-ligatures: normal; font-variant-caps: normal; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial'>To deal with the case where<SPAN>&nbsp;</SPAN><CODE class=filename style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">pg_control</CODE><SPAN>&nbsp;</SPAN>is corrupt, we should support the possibility of scanning existing WAL segments in reverse order &#8212; newest to oldest &#8212; in order to find the latest checkpoint. This has not been implemented yet.<SPAN>&nbsp;</SPAN><CODE class=filename style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">pg_control</CODE><SPAN>&nbsp;</SPAN>is small enough (less than one disk page) that it is not subject to partial-write problems, and as of this writing there have been no reports of database failures due solely to the inability to read<SPAN>&nbsp;</SPAN><CODE class=filename style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">pg_control</CODE><SPAN>&nbsp;</SPAN>itself. So while it is theoretically a weak spot,<SPAN>&nbsp;</SPAN><CODE class=filename style="BOX-SIZING: border-box; FONT-SIZE: 1em; FONT-FAMILY: monospace, monospace; MARGIN-TOP: 0px; FONT-WEIGHT: 400; COLOR:  !important; MARGIN-LEFT: 0px; MARGIN-RIGHT: 0px; overflow-wrap: break-word; border-radius: 0.25rem">pg_control</CODE><SPAN>&nbsp;</SPAN>does not seem to be a problem in practice.